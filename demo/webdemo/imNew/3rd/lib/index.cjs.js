"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("../assets/sdk/NIM_Web_SDK_v8.3.5.js"),e=require("../assets/sdk/NIM_Web_WebRTC2_v4.1.0.js");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function r(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,r.get?r:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var i=n(t),o=r(e),s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function l(t,e){function n(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var a=function(){return(a=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function c(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{a(r.next(t))}catch(t){o(t)}}function l(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,l)}a((r=r.apply(t,e||[])).next())}))}function u(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}}function h(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function f(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(h(arguments[e]));return t}var d={code:"100",message:"未知错误"},v={code:"101",message:"disconnect failed"},g={code:"102",message:"signal is null"},p={code:"103",message:"channelInfo is null"},m={code:"104",message:"client is null"},y={code:"105",message:"stream is null"},C={code:"106",message:"callType is null"},I={code:"107",message:"invite all failed"},w={code:"109",message:"groupInvite part failed"},b={code:"110",message:"cancel part failed"},S={code:"111",message:"signal leave failed"},j={code:"112",message:"G2 RTC leave failed"},T={code:"113",message:"durations is empty"},L={code:"114",message:"deviceId is null"},P={code:"115",message:"invitorChannelInfo is null"},k={code:"116",message:"call is busy"},R={code:"117",message:"becall is busy"},A={code:"118",message:"Only calling and inCall can use groupInvite"},O={code:"119",message:"not groupCall"},E={code:"120",message:"channelId is null"},M={code:"121",message:"rtcController is null"},N="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function _(t,e){return t(e={exports:{}},e.exports),e.exports}var H,U,G=_((function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}function i(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function o(t,e,r,o,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var l=new i(r,o||t,s),a=n?n+e:e;return t._events[a]?t._events[a].fn?t._events[a]=[t._events[a],l]:t._events[a].push(l):(t._events[a]=l,t._eventsCount++),t}function s(t,e){0==--t._eventsCount?t._events=new r:delete t._events[e]}function l(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),l.prototype.eventNames=function(){var t,r,i=[];if(0===this._eventsCount)return i;for(r in t=this._events)e.call(t,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(t)):i},l.prototype.listeners=function(t){var e=n?n+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,o=r.length,s=new Array(o);i<o;i++)s[i]=r[i].fn;return s},l.prototype.listenerCount=function(t){var e=n?n+t:t,r=this._events[e];return r?r.fn?1:r.length:0},l.prototype.emit=function(t,e,r,i,o,s){var l=n?n+t:t;if(!this._events[l])return!1;var a,c,u=this._events[l],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(t,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,e),!0;case 3:return u.fn.call(u.context,e,r),!0;case 4:return u.fn.call(u.context,e,r,i),!0;case 5:return u.fn.call(u.context,e,r,i,o),!0;case 6:return u.fn.call(u.context,e,r,i,o,s),!0}for(c=1,a=new Array(h-1);c<h;c++)a[c-1]=arguments[c];u.fn.apply(u.context,a)}else{var f,d=u.length;for(c=0;c<d;c++)switch(u[c].once&&this.removeListener(t,u[c].fn,void 0,!0),h){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,e);break;case 3:u[c].fn.call(u[c].context,e,r);break;case 4:u[c].fn.call(u[c].context,e,r,i);break;default:if(!a)for(f=1,a=new Array(h-1);f<h;f++)a[f-1]=arguments[f];u[c].fn.apply(u[c].context,a)}}return!0},l.prototype.on=function(t,e,n){return o(this,t,e,n,!1)},l.prototype.once=function(t,e,n){return o(this,t,e,n,!0)},l.prototype.removeListener=function(t,e,r,i){var o=n?n+t:t;if(!this._events[o])return this;if(!e)return s(this,o),this;var l=this._events[o];if(l.fn)l.fn!==e||i&&!l.once||r&&l.context!==r||s(this,o);else{for(var a=0,c=[],u=l.length;a<u;a++)(l[a].fn!==e||i&&!l[a].once||r&&l[a].context!==r)&&c.push(l[a]);c.length?this._events[o]=1===c.length?c[0]:c:s(this,o)}return this},l.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&s(this,e)):(this._events=new r,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=n,l.EventEmitter=l,t.exports=l})),V=_((function(t,e){var n,r,i;n=e,r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==N?N:"undefined"!=typeof self?self:{},i=function(t){var e={exports:{}};return t(e,e.exports),e.exports}((function(t){var e,n;e=r,n=function(){var t=function(){},e="undefined",n=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function i(t,e){var n=t[e];if("function"==typeof n.bind)return n.bind(t);try{return Function.prototype.bind.call(n,t)}catch(e){return function(){return Function.prototype.apply.apply(n,[t,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function s(r){return"debug"===r&&(r="log"),typeof console!==e&&("trace"===r&&n?o:void 0!==console[r]?i(console,r):void 0!==console.log?i(console,"log"):t)}function l(e,n){for(var i=0;i<r.length;i++){var o=r[i];this[o]=i<e?t:this.methodFactory(o,e,n)}this.log=this.debug}function a(t,n,r){return function(){typeof console!==e&&(l.call(this,n,r),this[t].apply(this,arguments))}}function c(t,e,n){return s(t)||a.apply(this,arguments)}function u(t,n,i){var o,s=this,a="loglevel";function u(){var t;if(typeof window!==e&&a){try{t=window.localStorage[a]}catch(t){}if(typeof t===e)try{var n=window.document.cookie,r=n.indexOf(encodeURIComponent(a)+"=");-1!==r&&(t=/^([^;]+)/.exec(n.slice(r))[1])}catch(t){}return void 0===s.levels[t]&&(t=void 0),t}}"string"==typeof t?a+=":"+t:"symbol"==typeof t&&(a=void 0),s.name=t,s.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},s.methodFactory=i||c,s.getLevel=function(){return o},s.setLevel=function(n,i){if("string"==typeof n&&void 0!==s.levels[n.toUpperCase()]&&(n=s.levels[n.toUpperCase()]),!("number"==typeof n&&n>=0&&n<=s.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(o=n,!1!==i&&function(t){var n=(r[t]||"silent").toUpperCase();if(typeof window!==e&&a){try{return void(window.localStorage[a]=n)}catch(t){}try{window.document.cookie=encodeURIComponent(a)+"="+n+";"}catch(t){}}}(n),l.call(s,n,t),typeof console===e&&n<s.levels.SILENT)return"No console available for logging"},s.setDefaultLevel=function(t){u()||s.setLevel(t,!1)},s.enableAll=function(t){s.setLevel(s.levels.TRACE,t)},s.disableAll=function(t){s.setLevel(s.levels.SILENT,t)};var h=u();null==h&&(h=null==n?"WARN":n),s.setLevel(h,!1)}var h=new u,f={};h.getLogger=function(t){if("symbol"!=typeof t&&"string"!=typeof t||""===t)throw new TypeError("You must supply a name when creating a logger.");var e=f[t];return e||(e=f[t]=new u(t,h.getLevel(),h.methodFactory)),e};var d=typeof window!==e?window.log:void 0;return h.noConflict=function(){return typeof window!==e&&window.log===h&&(window.log=d),h},h.getLoggers=function(){return f},h.default=h,h},t.exports?t.exports=n():e.log=n()})),n.default=function(t){var e=void 0===t?{appName:"",version:"",storeWindow:!1}:t,n=e.level,r=e.appName,o=void 0===r?"":r,s=e.version,l=void 0===s?"":s,a=e.storeWindow,c=void 0!==a&&a,u=new Proxy(i,{get:function(t,e){if(e in t){var n=t[e];if(!["log","info","warn","error","trace","debug"].includes(e))return n;var r,i,s={browser:(r=navigator.userAgent.toLocaleLowerCase().match(/(msie|firefox|chrome|opera|version).*?([\d.]+)/)||[])[1].replace(/version/,"safari"),ver:r[2]},a="[ "+o+" "+l+" "+s.browser+":"+s.ver+" "+(i=new Date).getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate()+" "+(i.getHours()<10?"0"+i.getHours():i.getHours())+":"+(i.getMinutes()<10?"0"+i.getMinutes():i.getMinutes())+":"+(i.getSeconds()<10?"0"+i.getSeconds():i.getSeconds())+" ]";return n.bind(null,a)}}});return n&&u.setLevel(n),c&&(window.__LOGGER__=u),u},Object.defineProperty(n,"__esModule",{value:!0})})),x=(H=V)&&H.__esModule&&Object.prototype.hasOwnProperty.call(H,"default")?H.default:H,q=function(t){function e(e){var n=e.debug,r=t.call(this)||this;return r.log=null,r.debug=!0,r.debug=n,r.log=n?x({appName:"NERTCCalling",version:"1.3.2",level:"trace"}).log:function(){},r}return l(e,t),e}(G),J=function(t){function n(e){var n=t.call(this,e)||this;return n.client=null,n.webrtc=o,n.appKey="",n.localStream=null,n.remoteStreams=[],n.localView=void 0,n.remoteViews=[],n.microphoneId="",n.cameraId="",n.speakerId="",n.audioEnabled=!1,n.videoEnabled=!1,n.getTokenFunc=null,n.resolution=8,n.frameRate=3,n.quality="speech_low_quality",n}return l(n,t),n.prototype.setupAppKey=function(t){var n=t.appKey;this.client||(this.appKey=n,this.client=e.createClient({appkey:this.appKey,debug:this.debug}),this.log("setupAppKey success"))},n.prototype.setTokenService=function(t){this.getTokenFunc=t},n.prototype.setCallProfile=function(t){var e=this;this.log("setCallProfile",t),Object.keys(t).forEach((function(n){t.hasOwnProperty(n)&&(e[n]=t[n])}))},n.prototype.setupLocalView=function(t){t&&(this.localView=t,this.log("setupLocalView set view success",t))},n.prototype.setupRemoteView=function(t,e){this.remoteViews.every((function(e){return e.uid!==t}))?this.remoteViews.push({uid:t,view:e}):this.remoteViews=this.remoteViews.map((function(n){return n.uid===t?a(a({},n),{view:e}):a({},n)}))},n.prototype.getDevices=function(){return c(this,void 0,void 0,(function(){var t,n,r,i,o,s,l=this;return u(this,(function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,e.getDevices()];case 1:for(o in t=c.sent(),n={audioIn:"microphoneId",audioOut:"speakerId",video:"cameraId"},r={},i=function(e){t.hasOwnProperty(e)&&(r[e]=t[e].map((function(t){return l[n[e]]===t.deviceId?a(a({},t),{active:!0}):a({},t)})))},t)i(o);return this.log("getDevices success",r),[2,r];case 2:return s=c.sent(),this.log("getDevices fail: ",s),[2,Promise.reject(s)];case 3:return[2]}}))}))},n.prototype.switchDevice=function(t,e){return c(this,void 0,void 0,(function(){var n;return u(this,(function(r){switch(r.label){case 0:switch(r.trys.push([0,8,,9]),t){case"microphoneId":return[3,1];case"cameraId":return[3,3];case"speakerId":return[3,5]}return[3,7];case 1:return this.microphoneId===e?[2,Promise.resolve()]:[4,this.enableLocalAudio(this.audioEnabled,e)];case 2:return r.sent(),[3,7];case 3:return this.cameraId===e?[2,Promise.resolve()]:[4,this.enableLocalVideo(this.videoEnabled,e)];case 4:return r.sent(),[3,7];case 5:return this.speakerId===e?[2,Promise.resolve()]:[4,this.selectSpeakers(e)];case 6:return r.sent(),[3,7];case 7:return this.log("switchDevice success",t,e),[3,9];case 8:return n=r.sent(),this.log("switchDevice fail: ",n,t,e),[2,Promise.reject(n)];case 9:return[2]}}))}))},n.prototype.setAudioMute=function(t,e){return c(this,void 0,void 0,(function(){var n,r;return u(this,(function(i){switch(i.label){case 0:if(!(n=this.remoteStreams.find((function(t){return t.getId()===e}))))return this.log("setAudioMute fail: ",y,e),[2,Promise.reject(y)];i.label=1;case 1:return i.trys.push([1,6,,7]),t?[4,n.muteAudio()]:[3,3];case 2:return i.sent(),[3,5];case 3:return[4,n.unmuteAudio()];case 4:i.sent(),i.label=5;case 5:return this.log("setAudioMute success",t,n),[3,7];case 6:return r=i.sent(),this.log("setAudioMute fail: ",r),[2,Promise.reject(r)];case 7:return[2]}}))}))},n.prototype.joinRTCChannel=function(t){var e=t.channelName,n=t.type,r=t.uid;return c(this,void 0,void 0,(function(){var t,i;return u(this,(function(o){switch(o.label){case 0:if(o.trys.push([0,6,,7]),this.log("joinRTCChannel",n,e,r),!this.client)throw m;return t="",this.getTokenFunc?[4,this.getTokenFunc(r)]:[3,2];case 1:t=o.sent(),this.log("getToken success",t),o.label=2;case 2:return[4,this.client.join({channelName:e,uid:r,token:t,joinChannelRecordConfig:this.recordConfig})];case 3:return o.sent(),this.emit("onJoinChannel",{uid:r,cid:this.client.getChannelInfo().cid,channelName:e}),[4,this.initLocalStream({type:n,uid:r})];case 4:return o.sent(),[4,this.client.publish(this.localStream)];case 5:return o.sent(),this.log("joinRTCChannel success"),[3,7];case 6:return i=o.sent(),this.log("joinRTCChannel fail:",i),[2,Promise.reject(i)];case 7:return[2]}}))}))},n.prototype.initLocalStream=function(t){var n,r,i,o=t.type,s=t.uid;return c(this,void 0,void 0,(function(){var t,l,a,c,h;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,4,,5]),this.log("initLocalStream",o,s),this.localStream=e.createStream({uid:s,audio:!0,video:2===o,screen:!1}),this.log("localStream create success"),this.localStream.setVideoProfile({resolution:this.resolution,frameRate:this.frameRate}),this.localStream.setAudioProfile(this.quality),[4,this.localStream.init()];case 1:return u.sent(),this.log("localStream init success"),[4,this.getDevices()];case 2:return t=u.sent(),l=t.audioIn,a=t.audioOut,c=t.video,this.microphoneId=(null===(n=l[0])||void 0===n?void 0:n.deviceId)||"",this.cameraId=(null===(r=c[0])||void 0===r?void 0:r.deviceId)||"",this.speakerId=(null===(i=a[0])||void 0===i?void 0:i.deviceId)||"",[4,this.startStreamPreview(this.localStream,"local",this.localView)];case 3:return u.sent(),this.log("startLocalStreamPreview success",this.localStream,this.localView),this.log("initLocalStream success"),[3,5];case 4:return h=u.sent(),this.log("initLocalStream fail:",h),[2,Promise.reject(h)];case 5:return[2]}}))}))},n.prototype.rtcSubscribe=function(t,e){return c(this,void 0,void 0,(function(){var n;return u(this,(function(r){switch(r.label){case 0:t.setSubscribeConfig(e),r.label=1;case 1:if(r.trys.push([1,3,,4]),!this.client)throw m;return[4,this.client.subscribe(t)];case 2:return r.sent(),this.log("rtcSubscribe success"),[3,4];case 3:return n=r.sent(),this.log("rtcSubscribe fail:",n),[2,Promise.reject(n)];case 4:return[2]}}))}))},n.prototype.rtcUnSubscribe=function(t,e){return c(this,void 0,void 0,(function(){var n;return u(this,(function(r){switch(r.label){case 0:t.setSubscribeConfig(e),r.label=1;case 1:if(r.trys.push([1,3,,4]),!this.client)throw m;return[4,this.client.unsubscribe(t)];case 2:return r.sent(),this.log("rtcUnSubscribe success"),[3,4];case 3:return n=r.sent(),this.log("rtcUnSubscribe fail:",n),[2,Promise.reject(n)];case 4:return[2]}}))}))},n.prototype.rtcLeave=function(){return c(this,void 0,void 0,(function(){var t;return u(this,(function(e){switch(e.label){case 0:if(e.trys.push([0,2,,3]),!this.client)throw m;return[4,this.client.leave()];case 1:return e.sent(),[3,3];case 2:return t=e.sent(),[2,Promise.reject(t)];case 3:return[2]}}))}))},n.prototype.startStreamPreview=function(t,e,n){return c(this,void 0,void 0,(function(){var r,i;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,t.play(n)];case 1:return o.sent(),this.log("startStreamPreview success",{stream:t,type:e,view:n}),n&&(r={width:n.clientWidth,height:n.clientHeight,cut:!0},t["local"===e?"setLocalRenderMode":"setRemoteRenderMode"](r),this.log("local"===e?"setLocalRenderMode":"setRemoteRenderMode success",{params:r,type:e})),[3,3];case 2:return i=o.sent(),this.log("startStreamPreview fail: ",i),[2,Promise.reject(i)];case 3:return[2]}}))}))},n.prototype.enableLocalVideo=function(t,e){return c(this,void 0,void 0,(function(){var n;return u(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,4,,5]),!this.localStream)throw y;return[4,this.localStream[t?"open":"close"]({type:"video",deviceId:e})];case 1:return r.sent(),this.videoEnabled=t,e&&(this.cameraId=e),t?[4,this.startStreamPreview(this.localStream,"local",this.localView)]:[3,3];case 2:r.sent(),r.label=3;case 3:return this.log("_enableLocalVideo success:",t,e),[3,5];case 4:return n=r.sent(),this.log("_enableLocalVideo fail:",t,e,n),[2,Promise.reject(n)];case 5:return[2]}}))}))},n.prototype.enableLocalAudio=function(t,e){return c(this,void 0,void 0,(function(){var n;return u(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,2,,3]),!this.localStream)throw y;return[4,this.localStream[t?"open":"close"]({type:"audio",deviceId:e})];case 1:return r.sent(),this.audioEnabled=t,e&&(this.microphoneId=e),this.log("enableLocalAudio success:",t,e),[3,3];case 2:return n=r.sent(),this.log("enableLocalAudio fail:",t,e,n),[2,Promise.reject(n)];case 3:return[2]}}))}))},n.prototype.muteLocalVideo=function(t){return c(this,void 0,void 0,(function(){var e;return u(this,(function(n){switch(n.label){case 0:if(n.trys.push([0,2,,3]),!this.localStream)throw y;return[4,this.localStream[t?"muteVideo":"unmuteVideo"]()];case 1:return n.sent(),[3,3];case 2:throw e=n.sent(),this.log("muteLocalVideo fail: ",t),e;case 3:return[2]}}))}))},n.prototype.muteLocalAudio=function(t){return c(this,void 0,void 0,(function(){var e;return u(this,(function(n){switch(n.label){case 0:if(n.trys.push([0,2,,3]),!this.localStream)throw y;return[4,this.localStream[t?"muteAudio":"unmuteAudio"]()];case 1:return n.sent(),[3,3];case 2:throw e=n.sent(),this.log("muteLocalAudio fail: ",t),e;case 3:return[2]}}))}))},n.prototype.addStream=function(t){var e=t.getId();this.remoteStreams.some((function(t){return t.getId()===e}))?(this.log("stream-added：订阅的流已存在，更新流"),this.updateStream(t)):(this.log("stream-added：新增需要订阅的流"),this.remoteStreams.push(t))},n.prototype.updateStream=function(t){var e=t.getId();this.remoteStreams=this.remoteStreams.map((function(n){return n.getId()===e?t:n}))},n.prototype.removeStream=function(t){this.remoteStreams=this.remoteStreams.filter((function(e){return e.getId()!==t}))},n.prototype.findRemoteView=function(t){return(this.remoteViews.find((function(e){return e.uid===t}))||{view:void 0}).view},n.prototype.resetState=function(){this.localStream=null,this.remoteStreams=[],this.localView=void 0,this.remoteViews=[],this.audioEnabled=!1,this.videoEnabled=!1,this.microphoneId="",this.cameraId="",this.speakerId="",this.resolution=8,this.frameRate=3,this.quality="speech_low_quality",this.recordConfig=void 0,this.log("rtcController resetState success")},n.prototype.removeRtcListeners=function(){this.off("onJoinChannel"),this.client&&(this.client.off("peer-online"),this.client.off("peer-leave"),this.client.off("stream-added"),this.client.off("stream-removed"),this.client.off("stream-subscribed"),this.client.off("mute-video"),this.client.off("unmute-video"),this.client.off("mute-audio"),this.client.off("unmute-audio"),this.client.off("network-quality"),this.client.off("channel-closed"))},n.prototype.destroy=function(){try{this.localStream.destroy(),e.destroy()}catch(t){}this.resetState(),this.removeRtcListeners(),this.client=null,this.webrtc=null,this.appKey="",this.getTokenFunc=null,this.debug=!1,this.log=null},n.prototype.selectSpeakers=function(t){var e;return c(this,void 0,void 0,(function(){var n,r,i,o,s,l;return u(this,(function(a){switch(a.label){case 0:if(a.trys.push([0,5,,6]),!this.client)throw m;if(!(n=null===(e=this.client.adapterRef)||void 0===e?void 0:e.audioHelperMap))throw d;if(!t)throw L;for(i in r=[],n)r.push(i);o=0,a.label=1;case 1:return o<r.length?(s=r[o],n[s]&&n[s].audioDomHelper&&n[s].audioDomHelper.audioDom?[4,this._selectSpeakers(n[s].audioDomHelper.audioDom,t)]:[3,3]):[3,4];case 2:a.sent(),a.label=3;case 3:return o++,[3,1];case 4:return this.log("selectSpeakers success",t),[3,6];case 5:return l=a.sent(),this.log("selectSpeakers fail: ",l,t),[2,Promise.reject(l)];case 6:return[2]}}))}))},n.prototype._selectSpeakers=function(t,e){return c(this,void 0,void 0,(function(){var n;return u(this,(function(r){switch(r.label){case 0:if(t&&void 0===t.sinkId)return[2];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,t.setSinkId(e)];case 2:return r.sent(),this.speakerId=e,[3,4];case 3:return n=r.sent(),[2,Promise.reject(n)];case 4:return[2]}}))}))},n}(q);!function(t){t[t.idle=0]="idle",t[t.calling=1]="calling",t[t.called=2]="called",t[t.inCall=3]="inCall"}(U||(U={}));var D=function(){return Math.ceil(1e5*Math.random())+""},F=function(t){function e(e,n){var r=t.call(this,n)||this;return r.signal=null,r.channelInfo=null,r.callingUserIds=[],r.requestId="",r.callType=null,r.invitorChannelInfo=null,r.isGroupCall=!1,r.callStatus=U.idle,r.callTimeout=void 0,r.rejectTimeout=void 0,r.hooks={beforeSignalCancel:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2,""]}))}))},beforeSignalCancelInGroupCall:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalJoin:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalJoinInGroupCall:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalCreateAndJoin:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalInvite:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalCancel:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalCancelInGroupCall:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalLeave:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalCancelInHangup:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalAccept:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterSignalAcceptInGroupCall:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterLeaveFinally:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},afterHangupFinally:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},signalInviteFail:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},signalInviteFailInGroupCall:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},signalAcceptFail:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalRoomJoin:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalRoomClose:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalRoomLeave:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalCancel:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalAccept:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalAcceptInGroupCall:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalInvited:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalReject:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalRejectInGroupCall:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalRejectIsValid:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2,!0]}))}))},whenSignalControl:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalRejectOtherClient:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},whenSignalAcceptOtherClient:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},onSignalChannelsSyncNotify:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},callTimeOut:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},groupCallTimeOut:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},groupInviteTimeOut:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},beCallTimeOut:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))},errorEvent:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return c(r,void 0,void 0,(function(){return u(this,(function(t){return[2]}))}))}},r.signal=e,r.initEventListener(),r.aliveTimer=setInterval((function(){var t;(null===(t=r.channelInfo)||void 0===t?void 0:t.channelId)&&r.signal.signalingDelay({channelId:r.channelInfo.channelId})}),12e4),r}return l(e,t),e.prototype.call=function(t){var e,n;return c(this,void 0,void 0,(function(){var r,i,o;return u(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,8,,9]),!this.signal)throw g;if(this.callStatus!==U.idle)throw k;return this.channelInfo?[3,4]:[4,this.signalCreate({type:t.type})];case 1:return r=s.sent(),[4,this.signal.signalingJoin({channelId:r.channelId,offlineEnabled:!0})];case 2:return i=s.sent(),this.log("signalingJoin success！"),[4,this.hooks.afterSignalJoin({uid:Number(i.members[0].uid)})];case 3:s.sent(),s.label=4;case 4:return this.callStatus=U.calling,this.isGroupCall=!1,[4,this.hooks.afterSignalCreateAndJoin(this.channelInfo)];case 5:return s.sent(),this.callingUserIds=[t.userId],[4,this.signalInvite({userId:t.userId,attachment:t.attachment})];case 6:return s.sent(),this.log("call success"),[4,this.hooks.afterSignalInvite()];case 7:return s.sent(),null===(e=t.success)||void 0===e||e.call(t),[3,9];case 8:return o=s.sent(),this.log("call fail:",o),null===(n=t.failed)||void 0===n||n.call(t,o),[2,Promise.reject(o)];case 9:return[2]}}))}))},e.prototype.groupCall=function(t){var e,n,r;return c(this,void 0,void 0,(function(){var i,o,s;return u(this,(function(l){switch(l.label){case 0:if(this.callStatus!==U.idle)return this.log("groupCall fail",k),null===(e=t.failed)||void 0===e||e.call(t,k),[2,Promise.reject(k)];l.label=1;case 1:if(l.trys.push([1,8,,10]),!this.signal)throw g;return this.channelInfo?[3,5]:[4,this.signalCreate({type:t.type})];case 2:return i=l.sent(),[4,this.signal.signalingJoin({channelId:i.channelId,offlineEnabled:!0})];case 3:return o=l.sent(),[4,this.hooks.afterSignalJoinInGroupCall({uid:Number(o.members[0].uid),channelId:i.channelId,type:t.type})];case 4:l.sent(),l.label=5;case 5:return this.isGroupCall=!0,this.callStatus=U.calling,[4,this.hooks.afterSignalCreateAndJoin(this.channelInfo)];case 6:return l.sent(),[4,this.signalGroupInvite({userIds:t.userIds,groupId:t.groupId,attachment:t.attachment})];case 7:return l.sent(),this.log("groupCall success"),null===(n=t.success)||void 0===n||n.call(t),[3,10];case 8:return s=l.sent(),this.log("groupCall fail",s),[4,this.signalClose()];case 9:return l.sent(),this.resetState(),null===(r=t.failed)||void 0===r||r.call(t,s),[2,Promise.reject(s)];case 10:return[2]}}))}))},e.prototype.accept=function(t){var e,n;return c(this,void 0,void 0,(function(){var r;return u(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),!this.signal)throw g;return[4,this.acceptSignal()];case 1:return i.sent(),this.callStatus=U.inCall,this.log("accept success"),null===(e=null==t?void 0:t.success)||void 0===e||e.call(t),[3,3];case 2:return r=i.sent(),this.log("accept fail:",r),null===(n=null==t?void 0:t.failed)||void 0===n||n.call(t,r),[2,Promise.reject(r)];case 3:return[2]}}))}))},e.prototype.cancel=function(t){var e,n;return c(this,void 0,void 0,(function(){var r,i;return u(this,(function(o){switch(o.label){case 0:if(o.trys.push([0,11,,12]),!this.signal)throw g;if(!this.channelInfo)throw p;return r="",this.isGroupCall?[3,2]:[4,this.hooks.beforeSignalCancel(this.callingUserIds)];case 1:return r=o.sent(),[3,4];case 2:return[4,this.hooks.beforeSignalCancelInGroupCall(this.callingUserIds)];case 3:o.sent(),o.label=4;case 4:return[4,this.signalCancel()];case 5:return o.sent(),this.isGroupCall?[3,8]:[4,this.hooks.afterSignalCancel(r)];case 6:return o.sent(),[4,this.signalClose()];case 7:return o.sent(),this.resetState(),[3,10];case 8:return[4,this.hooks.afterSignalCancelInGroupCall()];case 9:o.sent(),this.clearTimer(),o.label=10;case 10:return this.log("cancel success"),null===(e=null==t?void 0:t.success)||void 0===e||e.call(t),[3,12];case 11:return i=o.sent(),this.log("cancel fail",i),null===(n=null==t?void 0:t.failed)||void 0===n||n.call(t,i),[2,Promise.reject(i)];case 12:return[2]}}))}))},e.prototype.reject=function(t){var e,n;return c(this,void 0,void 0,(function(){var r;return u(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,3,4]),!this.invitorChannelInfo)throw P;return[4,this.rejectCall(!1,{channelId:this.invitorChannelInfo.channelId,account:this.invitorChannelInfo.from,requestId:this.invitorChannelInfo.requestId})];case 1:return i.sent(),this.log("reject success"),null===(e=null==t?void 0:t.success)||void 0===e||e.call(t),[3,4];case 2:return r=i.sent(),this.log("reject fail:",r),null===(n=null==t?void 0:t.failed)||void 0===n||n.call(t,r),[2,Promise.reject(r)];case 3:return this.invitorChannelInfo=null,[7];case 4:return[2]}}))}))},e.prototype.leave=function(t){var e,n,r;return c(this,void 0,void 0,(function(){var i,o;return u(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,3,4,6]),!this.signal)throw g;if(!(i=(null==t?void 0:t.channelId)||(null===(e=this.channelInfo)||void 0===e?void 0:e.channelId)))throw E;return[4,this.signalLeave(i)];case 1:return s.sent(),[4,this.hooks.afterSignalLeave()];case 2:return s.sent(),this.log("leave success"),null===(n=null==t?void 0:t.success)||void 0===n||n.call(t),[3,6];case 3:return o=s.sent(),this.log("leave fail:",o),null===(r=null==t?void 0:t.failed)||void 0===r||r.call(t,o),[2,Promise.reject(o)];case 4:return[4,this.hooks.afterLeaveFinally()];case 5:return s.sent(),this.resetState(),[7];case 6:return[2]}}))}))},e.prototype.hangup=function(t){var e,n;return c(this,void 0,void 0,(function(){var r;return u(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,4,5,7]),!this.signal)throw g;if(!this.channelInfo)throw p;return[4,this.signalCancel()];case 1:return i.sent(),[4,this.hooks.afterSignalCancelInHangup()];case 2:return i.sent(),[4,this.signalClose()];case 3:return i.sent(),this.log("hangup success"),null===(e=null==t?void 0:t.success)||void 0===e||e.call(t),[3,7];case 4:return r=i.sent(),this.log("hangup fail:",r),null===(n=null==t?void 0:t.failed)||void 0===n||n.call(t,r),[2,Promise.reject(r)];case 5:return[4,this.hooks.afterHangupFinally()];case 6:return i.sent(),this.resetState(),[7];case 7:return[2]}}))}))},e.prototype.groupInvite=function(t){var e,n;return c(this,void 0,void 0,(function(){var r;return u(this,(function(i){switch(i.label){case 0:if(!this.isGroupCall)return[2,Promise.reject(O)];if(this.callStatus!==U.calling&&this.callStatus!==U.inCall)return[2,Promise.reject(A)];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.signalGroupInvite(t)];case 2:return i.sent(),this.log("groupInvite success"),null===(e=t.success)||void 0===e||e.call(t),[3,4];case 3:return r=i.sent(),this.log("groupInvite fail",r),this.callStatus=U.inCall,this.clearTimer(),null===(n=t.failed)||void 0===n||n.call(t,r),[2,Promise.reject(r)];case 4:return[2]}}))}))},e.prototype.setCallTimeout=function(t){this.callTimeout=this.rejectTimeout=t},e.prototype.resetState=function(){this.channelInfo=null,this.callingUserIds=[],this.requestId="",this.callType=null,this.invitorChannelInfo=null,this.isGroupCall=!1,this.callStatus=U.idle,this.clearTimer()},e.prototype.joinChannel=function(t){return c(this,void 0,void 0,(function(){var e,n;return u(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,2,,3]),!this.signal)throw g;return[4,this.signal.signalingJoin({channelId:t,offlineEnabled:!0})];case 1:return e=r.sent(),this.log("joinChannel success: ",e.channelInfo),this.channelInfo=e.channelInfo,[2,e];case 2:return n=r.sent(),this.log("joinChannel failed: ",n),[2,Promise.reject(n)];case 3:return[2]}}))}))},e.prototype.getChannelInfo=function(t){return c(this,void 0,void 0,(function(){var e,n;return u(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,2,,3]),!this.signal)throw g;return[4,this.signal.signalingGetChannelInfo({channelName:t})];case 1:return e=r.sent(),this.log("getChannelInfo success: ",e),[2,e];case 2:return n=r.sent(),this.log("getChannelInfo failed: ",n),[2,Promise.reject(n)];case 3:return[2]}}))}))},e.prototype.destroy=function(){var t=this;this.resetState(),this.signal.removeListener("signalingNotify"),this.signal.removeListener("signalingMutilClientSyncNotify"),this.signal.removeListener("signalingUnreadMessageSyncNotify"),Object.keys(this.hooks).forEach((function(e){t.hooks[e]=function(){}})),clearInterval(this.aliveTimer),this.aliveTimer=null,this.signal=null,this.debug=!1,this.log=null},e.prototype.inject=function(t,e){this.hooks[t]=e},e.prototype.signalCreate=function(t){var e=t.type;return c(this,void 0,void 0,(function(){var t,n;return u(this,(function(r){switch(r.label){case 0:this.callType||(this.callType=e),r.label=1;case 1:return r.trys.push([1,3,,4]),t=this,[4,this.signal.signalingCreate({type:e})];case 2:return t.channelInfo=r.sent(),this.log("signalingCreate Success","channelInfo:",this.channelInfo,"callType:",this.callType),[2,this.channelInfo];case 3:return n=r.sent(),this.log("signalingCreate failed:",n,"callType:",this.callType),[2,Promise.reject(n)];case 4:return[2]}}))}))},e.prototype.signalInvite=function(t){return c(this,void 0,void 0,(function(){var e,n,r,i,o=this;return u(this,(function(s){switch(s.label){case 0:if(!this.channelInfo)return[2,Promise.reject(p)];s.label=1;case 1:s.trys.push([1,6,,9]),this.requestId=D(),e=JSON.stringify({callType:0,_attachment:t.attachment}),n={channelId:this.channelInfo.channelId,offlineEnabled:!0,account:t.userId,requestId:this.requestId,pushInfo:{pushTitle:"邀请通知",pushContent:"你收到了邀请",pushPayload:{},needPush:!0,needBadge:!0},attachExt:e},this.log("signalingInvite in call",n),s.label=2;case 2:return s.trys.push([2,4,,5]),[4,this.signal.signalingInvite(n)];case 3:return s.sent(),[3,5];case 4:if(r=s.sent(),!/OFFLINE/i.test(null==r?void 0:r.message))throw r;return[3,5];case 5:return this.log("signalInvite success！"),void 0!==this.callTimeout&&(this.callTimer=setTimeout((function(){return c(o,void 0,void 0,(function(){var e;return u(this,(function(n){switch(n.label){case 0:if(this.callStatus!==U.calling)return[3,7];n.label=1;case 1:return n.trys.push([1,3,4,7]),[4,this.signalCancel()];case 2:return n.sent(),this.log("signalInvite timeout cancel success",this.callTimeout),[3,7];case 3:return e=n.sent(),this.log("signalInvite timeout cancel fail: ",e,this.callTimeout),[3,7];case 4:return[4,this.hooks.callTimeOut(t.userId)];case 5:return n.sent(),[4,this.signalClose()];case 6:return n.sent(),this.resetState(),[7];case 7:return[2]}}))}))}),this.callTimeout)),[3,9];case 6:return i=s.sent(),this.log("signalInvite fail:",{channelId:this.channelInfo.channelId,requestId:this.requestId},i),this.callingUserIds=this.callingUserIds.filter((function(e){return e!==t.userId})),[4,this.hooks.signalInviteFail()];case 7:return s.sent(),[4,this.signalClose()];case 8:return s.sent(),this.resetState(),[2,Promise.reject(i)];case 9:return[2]}}))}))},e.prototype.signalGroupInvite=function(t){return c(this,void 0,void 0,(function(){var e,n,r,i,o=this;return u(this,(function(s){switch(s.label){case 0:return this.channelInfo?(this.requestId=D(),e=t.userIds.filter((function(t){return!o.callingUserIds.includes(t)})),this.log("needCallingUserIds: ",e),this.callingUserIds=this.callingUserIds.concat(e),n=JSON.stringify({callType:1,callUserList:this.callingUserIds,groupID:void 0===t.groupId?null:t.groupId,_attachment:t.attachment}),[4,Promise.allSettled(e.map((function(t){var e={channelId:o.channelInfo.channelId,offlineEnabled:!0,account:t,requestId:o.requestId,pushInfo:{pushTitle:"邀请通知",pushContent:"你收到了邀请",pushPayload:{},needPush:!0,needBadge:!0},attachExt:n};return o.log("signalingInvite in groupCall",e),o.signal.signalingInvite(e).then((function(){return Promise.resolve()})).catch((function(t){return/OFFLINE/i.test(null==t?void 0:t.message)?Promise.resolve():Promise.reject(t)}))})))]):[2,Promise.reject(p)];case 1:return(r=s.sent()).length?(i=e.filter((function(t,e){return"rejected"===r[e].status})),this.callingUserIds=this.callingUserIds.filter((function(t){return!i.includes(t)})),r.every((function(t){return"rejected"===t.status}))?(this.log("signalGroupInvite fail",r),[4,this.hooks.signalInviteFailInGroupCall()]):[3,3]):(this.log("signalGroupInvite do not have needCallingUserIds"),[2,Promise.resolve()]);case 2:return s.sent(),[2,Promise.reject(I)];case 3:return i.length&&(this.log("signalGroupInvite part fail:",i),this.hooks.errorEvent(w,i)),this.log("signalGroupInvite success"),void 0!==this.callTimeout&&(clearTimeout(this.callTimer),this.callTimer=setTimeout((function(){return c(o,void 0,void 0,(function(){var t;return u(this,(function(e){switch(e.label){case 0:if(this.callStatus!==U.calling&&this.callStatus!==U.inCall)return[3,10];e.label=1;case 1:return e.trys.push([1,3,4,10]),[4,this.signalCancel()];case 2:return e.sent(),this.log("signalGroupInvite timeout cancel success",this.callStatus),[3,10];case 3:return t=e.sent(),this.log("signalGroupInvite timeout cancel fail: ",t,this.callStatus),[3,10];case 4:return this.callStatus!==U.calling?[3,7]:[4,this.hooks.groupCallTimeOut()];case 5:return e.sent(),[4,this.signalClose()];case 6:return e.sent(),this.resetState(),[3,9];case 7:return this.callStatus!==U.inCall?[3,9]:[4,this.hooks.groupInviteTimeOut()];case 8:e.sent(),this.clearTimer(),e.label=9;case 9:return[7];case 10:return[2]}}))}))}),this.callTimeout)),[2,Promise.resolve()]}}))}))},e.prototype.signalCancel=function(){return c(this,void 0,void 0,(function(){var t,e,n=this;return u(this,(function(r){switch(r.label){case 0:return[4,Promise.allSettled(this.callingUserIds.map((function(t){return n.signal.signalingCancel({channelId:n.channelInfo.channelId,account:t,requestId:n.requestId,offlineEnabled:!0})})))];case 1:return t=r.sent(),(e=this.callingUserIds.filter((function(e,n){return"rejected"===t[n].status}))).length?(this.log("signalCancel part fail:",e),[4,this.hooks.errorEvent(b,e)]):[3,3];case 2:r.sent(),r.label=3;case 3:return this.callingUserIds=[],this.log("signalCancel success"),[2,Promise.resolve()]}}))}))},e.prototype.acceptSignal=function(){return c(this,void 0,void 0,(function(){var t,e;return u(this,(function(n){switch(n.label){case 0:return n.trys.push([0,6,,9]),this.invitorChannelInfo?[4,this.signal.signalingAccept({channelId:this.invitorChannelInfo.channelId,account:this.invitorChannelInfo.from,requestId:this.invitorChannelInfo.requestId,offlineEnabled:!0,autoJoin:!0})]:[2,Promise.reject(P)];case 1:return t=n.sent(),this.log("signalingAccept success",t),this.channelInfo=t,this.callType=this.invitorChannelInfo.type,this.invitorChannelInfo=null,this.isGroupCall?[4,this.hooks.afterSignalAcceptInGroupCall({members:t.members,channelId:t.channelId,type:this.callType})]:[3,3];case 2:return n.sent(),[3,5];case 3:return[4,this.hooks.afterSignalAccept({members:t.members})];case 4:n.sent(),n.label=5;case 5:return[3,9];case 6:return e=n.sent(),this.log("acceptSignal fail:",e),[4,this.hooks.signalAcceptFail(e)];case 7:return n.sent(),[4,this.signalClose()];case 8:return n.sent(),this.resetState(),[2,Promise.reject(e)];case 9:return[2]}}))}))},e.prototype.signalLeave=function(t){return c(this,void 0,void 0,(function(){var e;return u(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,3,4]),[4,this.signal.signalingLeave({channelId:t,offlineEnabled:!0})];case 1:return n.sent(),this.log("signalLeave success"),[3,4];case 2:return e=n.sent(),this.log("signalLeave fail but resolve:",e),this.hooks.errorEvent(S),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},e.prototype.signalClose=function(){return c(this,void 0,void 0,(function(){var t;return u(this,(function(e){switch(e.label){case 0:if(e.trys.push([0,2,3,4]),!this.signal)throw g;if(!this.channelInfo)throw p;return[4,this.signal.signalingClose({channelId:this.channelInfo.channelId,offlineEnabled:!0})];case 1:return e.sent(),this.log("signalClose success"),[3,4];case 2:return t=e.sent(),this.log("signalClose fail but resolve:",this.channelInfo,t),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},e.prototype.rejectCall=function(t,e){return void 0===t&&(t=!1),c(this,void 0,void 0,(function(){var n,r;return u(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,3,4]),!this.signal)throw g;return n={channelId:e.channelId,account:e.account,requestId:e.requestId,offlineEnabled:!0},t&&(n.attachExt="601"),[4,this.signal.signalingReject(n)];case 1:return i.sent(),this.log("rejectCall success"),[3,4];case 2:return r=i.sent(),this.log("rejectCall fail:",e,r),[2,Promise.reject(r)];case 3:return t||(this.callStatus=U.idle),[7];case 4:return[2]}}))}))},e.prototype.initEventListener=function(){var t=this;this.signal.on("signalingNotify",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return[4,this.batchMarkEvent([e])];case 1:if(t.sent(),this.channelInfo&&e.channelId!==this.channelInfo.channelId&&"INVITE"!==e.eventType)return[2];switch(e.eventType){case"ROOM_JOIN":return[3,2];case"ROOM_CLOSE":return[3,3];case"LEAVE":return[3,4];case"INVITE":return[3,5];case"CANCEL_INVITE":return[3,6];case"REJECT":return[3,7];case"ACCEPT":return[3,8];case"CONTROL":return[3,9]}return[3,13];case 2:return this.signalRoomJoinHandler(e),[3,13];case 3:return this.roomCloseHandler(e),[3,13];case 4:return this.signalLeaveHandler(e),[3,13];case 5:return this.inviteHandler(e),[3,13];case 6:return this.cancelInviteHandler(e),[3,13];case 7:return this.rejectHandler(e),[3,13];case 8:return this.acceptHandler(e),[3,13];case 9:return t.trys.push([9,11,,12]),[4,this.hooks.whenSignalControl(e)];case 10:return t.sent(),[3,12];case 11:return t.sent(),this.resetState(),[3,12];case 12:return[3,13];case 13:return[2]}}))}))})),this.signal.on("signalingMutilClientSyncNotify",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.log("signalingMutilClientSyncNotify",e),[4,this.batchMarkEvent([e])];case 1:switch(t.sent(),e.eventType){case"REJECT":return[3,2];case"ACCEPT":return[3,4]}return[3,6];case 2:return[4,this.hooks.whenSignalRejectOtherClient()];case 3:return t.sent(),this.resetState(),[3,6];case 4:return[4,this.hooks.whenSignalAcceptOtherClient()];case 5:return t.sent(),this.resetState(),[3,6];case 6:return[2]}}))}))})),this.signal.on("signalingUnreadMessageSyncNotify",(function(e){return c(t,void 0,void 0,(function(){var t,n,r;return u(this,(function(i){switch(i.label){case 0:return this.log("signalingUnreadMessageSyncNotify",e),[4,this.batchMarkEvent(e)];case 1:return i.sent(),t=e.filter((function(t){return!t.channelInValid})),n=t.filter((function(t){return"CANCEL_INVITE"===t.eventType})),(r=t.filter((function(t){return"INVITE"===t.eventType})).sort((function(t,e){return e.channelCreateTime-t.channelCreateTime})))[0]&&n.every((function(t){return t.requestId!==r[0].requestId}))?[4,this.inviteHandler(r[0])]:[3,3];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))})),this.signal.on("signalingChannelsSyncNotify",(function(e){t.log("onSignalChannelsSyncNotify",e),t.hooks.onSignalChannelsSyncNotify(e)}))},e.prototype.signalRoomJoinHandler=function(t){return c(this,void 0,void 0,(function(){var e,n;return u(this,(function(r){switch(r.label){case 0:this.log("signalRoomJoinHandler:",t);try{e=JSON.parse(t.attach)}catch(t){e={}}return n=(e.member||{})[2],this.filterCallingUserByMembers([{uid:n,account:t.from}]),[4,this.hooks.whenSignalRoomJoin({uid:n,from:t.from})];case 1:return r.sent(),[2]}}))}))},e.prototype.roomCloseHandler=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return this.log("roomCloseHandler:",t),[4,this.hooks.whenSignalRoomClose()];case 1:return e.sent(),[4,this.signalClose()];case 2:return e.sent(),this.resetState(),[2]}}))}))},e.prototype.signalLeaveHandler=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return this.log("signalLeaveHandler: ",t),[4,this.hooks.whenSignalRoomLeave()];case 1:return e.sent(),[2]}}))}))},e.prototype.acceptHandler=function(t){return c(this,void 0,void 0,(function(){var e;return u(this,(function(n){switch(n.label){case 0:return this.callStatus=U.inCall,this.clearTimer(),this.isGroupCall?[4,this.hooks.whenSignalAcceptInGroupCall({from:t.from})]:[3,2];case 1:return n.sent(),this.log("acceptHandler from group:",t),[2,Promise.resolve()];case 2:if(n.trys.push([2,4,,5]),!this.channelInfo)throw p;if(!this.callType)throw C;if(!this.signal)throw g;return[4,this.hooks.whenSignalAccept({from:t.from,channelId:this.channelInfo.channelId,type:this.callType})];case 3:return n.sent(),this.log("acceptHandler from signal success:",t),[3,5];case 4:return e=n.sent(),this.log("acceptHandler from signal fail:",t,e),this.resetState(),this.hooks.errorEvent(e),[3,5];case 5:return[2]}}))}))},e.prototype.inviteHandler=function(t){return c(this,void 0,void 0,(function(){var e,n,r,i=this;return u(this,(function(o){switch(o.label){case 0:if(t.channelInValid)return[2];if(this.log("inviteHandler:","callStatus:",this.callStatus,t),this.callStatus===U.idle)return[3,5];this.log(R),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.rejectCall(!0,{channelId:t.channelId,account:t.from,requestId:t.requestId})];case 2:return o.sent(),[3,4];case 3:return e=o.sent(),this.log("reject error in inviteHandler: ",e),[3,4];case 4:return[2];case 5:try{n=JSON.parse(t.attachExt)}catch(t){n={}}return r=Number(t.type),this.invitorChannelInfo={channelId:t.channelId,channelName:t.channelName,creatorId:t.creator,requestId:t.requestId,from:t.from,type:r},this.callStatus=U.called,this.isGroupCall=n.callType+""=="1",[4,this.hooks.whenSignalInvited({invitor:t.from,userIds:n.callUserList,isFromGroup:this.isGroupCall,groupID:n.groupID||n.groupId,attachment:n._attachment,type:r})];case 6:return o.sent(),void 0!==this.rejectTimeout&&(this.rejectTimer=setTimeout((function(){return c(i,void 0,void 0,(function(){var t;return u(this,(function(e){switch(e.label){case 0:if(this.callStatus!==U.called)return[3,6];e.label=1;case 1:return e.trys.push([1,3,4,6]),[4,this.rejectCall(!1,{channelId:this.invitorChannelInfo.channelId,account:this.invitorChannelInfo.from,requestId:this.invitorChannelInfo.requestId})];case 2:return e.sent(),this.log("reject timeout success",this.rejectTimeout),[3,6];case 3:return t=e.sent(),this.log("reject timeout fail: ",t,this.rejectTimeout),[3,6];case 4:return this.invitorChannelInfo=null,[4,this.hooks.beCallTimeOut()];case 5:return e.sent(),[7];case 6:return[2]}}))}))}),this.rejectTimeout)),[2]}}))}))},e.prototype.cancelInviteHandler=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return this.log("cancelInviteHandler:",t),this.resetState(),[4,this.hooks.whenSignalCancel(t.from)];case 1:return e.sent(),[2]}}))}))},e.prototype.rejectHandler=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,this.hooks.whenSignalRejectIsValid({requestId:this.requestId,to:t.to,event:t})];case 1:return e.sent()?(this.log("rejectHandler:",t),this.filterCallingUserByMembers([{uid:0,account:t.from}]),this.isGroupCall?[4,this.hooks.whenSignalRejectInGroupCall(t)]:[3,3]):(this.log("rejectHandler fail: invalid reject"),[2]);case 2:return e.sent(),[3,6];case 3:return[4,this.hooks.whenSignalReject(t)];case 4:return e.sent(),[4,this.signalClose()];case 5:e.sent(),this.resetState(),e.label=6;case 6:return[2]}}))}))},e.prototype.batchMarkEvent=function(t){return c(this,void 0,void 0,(function(){var e,n;return u(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,3,4]),e=t.map((function(t){return t.msgid+""})),[4,this.signal.signalingMarkMsgRead({msgid:e})];case 1:return r.sent(),this.log("在线 signalingMarkMsgRead success"),[3,4];case 2:return n=r.sent(),this.log("在线 signalingMarkMsgRead fail: ",n),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},e.prototype.filterCallingUserByMembers=function(t){void 0===t&&(t=[]),this.log("filterCallingUserByMembers:",t),this.callingUserIds=this.callingUserIds.filter((function(e){return t.every((function(t){return t.account!==e}))}))},e.prototype.clearTimer=function(){this.callTimer&&(clearTimeout(this.callTimer),this.callTimer=null),this.rejectTimer&&(clearTimeout(this.rejectTimer),this.rejectTimer=null)},e}(q),B=function(t){function e(e){var n=(void 0===e?{debug:!0}:e).debug,r=void 0===n||n,i=t.call(this,{debug:r})||this;return i.signal=null,i.rtcController=null,i.signalController=null,i.isConnect=!1,i.account="",i.uid=0,i.durations=[],i.userMap={},i.eventBound=!1,i.otherClients=new Map,i.rtcController=new J({debug:r}),i}return l(e,t),e.prototype.setupAppKey=function(t){if(!this.rtcController)throw M;this.rtcController.setupAppKey(t),this.addRtcListeners()},e.prototype.login=function(t){var e=this,n=t.account,r=t.token,o=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]])}return n}(t,["account","token"]);if(!this.rtcController)throw M;this.signal=i.default.NIM.getInstance(a(a({},o),{appKey:this.rtcController.appKey,account:n,token:r,debug:this.debug,onconnect:function(){for(var t,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];e.log.apply(e,f(["login onconnect"],r)),null===(t=o.onconnect)||void 0===t||t.call.apply(t,f([o],r)),e.isConnect=!0,e.account=n,e.signal.signalingSync()},onerror:function(){for(var t,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];e.log.apply(e,f(["login onerror:"],n)),null===(t=o.onerror)||void 0===t||t.call.apply(t,f([o],n))},onloginportschange:function(){for(var t,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];e.log.apply(e,f(["onloginportschange"],n)),null===(t=o.onloginportschange)||void 0===t||t.call.apply(t,f([o],n));var i=n[0]||[];i.forEach((function(t){t.online?e.otherClients.set(t.connectionId,t):e.otherClients.delete(t.connectionId)}))},ondisconnect:function(){for(var t,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];e.log.apply(e,f(["ondisconnect"],n)),null===(t=o.ondisconnect)||void 0===t||t.call.apply(t,f([o],n)),e.logoutHandler()}})),this.eventBound||(this.eventBound=!0,this.signalController=new F(this.signal,{debug:this.debug}),this.addSignalHooks())},e.prototype.logout=function(t){var e,n;return c(this,void 0,void 0,(function(){var r;return u(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),!this.isConnect)throw v;if(!this.signal)throw g;return[4,this.signal.destroy()];case 1:return i.sent(),this.log("logout trigger success"),null===(e=null==t?void 0:t.success)||void 0===e||e.call(t),[3,3];case 2:return r=i.sent(),this.log("logout trigger fail:",r),null===(n=null==t?void 0:t.failed)||void 0===n||n.call(t,v),[2,Promise.reject(v)];case 3:return[2]}}))}))},e.prototype.destroy=function(){var t,n;this.log("rtcCalling destroy success"),null===(t=this.signalController)||void 0===t||t.destroy(),null===(n=this.rtcController)||void 0===n||n.destroy(),this.signalController=null,this.rtcController=null,this.durations=[],this.signal=null,this.eventBound=!1,this.isConnect=!1,this.uid=0,this.account="",this.userMap={},this.otherClients.clear(),this.removeAllListeners(),this.log=null,this.debug=!1,e.instance=null},e.prototype.setTokenService=function(t){if(!this.rtcController)throw M;return this.rtcController.setTokenService(t)},e.prototype.setCallProfile=function(t){if(!this.rtcController)throw M;return this.rtcController.setCallProfile(t)},e.prototype.setCallTimeout=function(t){if(!this.signalController)throw g;this.signalController.setCallTimeout(t)},e.prototype.setupLocalView=function(t){if(!this.rtcController)throw M;return this.rtcController.setupLocalView(t)},e.prototype.setupRemoteView=function(t,e){if(!this.rtcController)throw M;var n=this.findUid(t);return this.rtcController.setupRemoteView(n,e)},e.prototype.addDelegate=function(t,e){this.on(t,e)},e.prototype.removeDelegate=function(t){this.off(t)},e.prototype.call=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){return this.signalController?[2,this.signalController.call(t)]:[2,Promise.reject(g)]}))}))},e.prototype.groupCall=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){return this.signalController?[2,this.signalController.groupCall(t)]:[2,Promise.reject(g)]}))}))},e.prototype.cancel=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){return this.signalController?[2,this.signalController.cancel(t)]:[2,Promise.reject(g)]}))}))},e.prototype.accept=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){return this.signalController?[2,this.signalController.accept(t)]:[2,Promise.reject(g)]}))}))},e.prototype.reject=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){return this.signalController?[2,this.signalController.reject(t)]:[2,Promise.reject(g)]}))}))},e.prototype.leave=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){return this.signalController?[2,this.signalController.leave(t)]:[2,Promise.reject(g)]}))}))},e.prototype.hangup=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){return this.signalController?[2,this.signalController.hangup(t)]:[2,Promise.reject(g)]}))}))},e.prototype.groupInvite=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){return this.signalController?[2,this.signalController.groupInvite(t)]:[2,Promise.reject(g)]}))}))},e.prototype.enableLocalVideo=function(t){return this.rtcController?this.rtcController.enableLocalVideo(t):Promise.reject(M)},e.prototype.enableLocalAudio=function(t){return this.rtcController?this.rtcController.enableLocalAudio(t):Promise.reject(M)},e.prototype.muteLocalVideo=function(t){return this.rtcController?this.rtcController.muteLocalVideo(t):Promise.reject(M)},e.prototype.muteLocalAudio=function(t){return this.rtcController?this.rtcController.muteLocalAudio(t):Promise.reject(M)},e.prototype.switchCallType=function(t){return c(this,void 0,void 0,(function(){var e,n;return u(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,6,,7]),1!==t)throw"sorry，目前仅支持视频切换为音频";if(!this.signal||!this.signalController)throw g;if(!this.rtcController)throw M;if(!this.signalController.channelInfo)throw p;r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.rtcController.enableLocalVideo(!1)];case 2:return r.sent(),[3,4];case 3:return e=r.sent(),this.log("enableLocalVideo in switchCallType fail but resolve",e),[3,4];case 4:return[4,this.signal.signalingControl({channelId:this.signalController.channelInfo.channelId,account:"",attachExt:JSON.stringify({cid:2,type:1})})];case 5:return r.sent(),this.log("switchCallType success"),[3,7];case 6:return n=r.sent(),this.log("switchCallType fail: ",n),[2,Promise.reject(n)];case 7:return[2]}}))}))},e.prototype.setAudioMute=function(t,e){return c(this,void 0,void 0,(function(){var n;return u(this,(function(r){return this.rtcController?(n=this.findUid(e),[2,this.rtcController.setAudioMute(t,n)]):[2,Promise.reject(M)]}))}))},e.prototype.getDevices=function(){return this.rtcController?this.rtcController.getDevices():Promise.reject(M)},e.prototype.switchDevice=function(t,e){return this.rtcController?this.rtcController.switchDevice(t,e):Promise.reject(M)},e.prototype.getRoomInfo=function(){return c(this,void 0,void 0,(function(){var t,e,n;return u(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,2,,3]),!this.signalController)throw g;if(!this.signalController.channelInfo)throw p;return e=[{}],[4,this.signalController.getChannelInfo(this.signalController.channelInfo.channelName)];case 1:return t=a.apply(void 0,[a.apply(void 0,e.concat([r.sent()])),{uid:this.uid}]),this.log("getRoomInfo success",t),[2,t];case 2:return n=r.sent(),this.log("getRoomInfo failed",n),[2,Promise.reject(n)];case 3:return[2]}}))}))},e.prototype.getSdkInstance=function(){var t,e;return{signal:this.signal,rtcClient:null===(t=this.rtcController)||void 0===t?void 0:t.client,WebRTC2:null===(e=this.rtcController)||void 0===e?void 0:e.webrtc}},e.prototype.rtcLeave=function(){return c(this,void 0,void 0,(function(){var t;return u(this,(function(e){switch(e.label){case 0:if(e.trys.push([0,2,3,4]),!this.rtcController)throw M;return[4,this.rtcController.rtcLeave()];case 1:return e.sent(),this.log("rtcLeave success"),[3,4];case 2:return t=e.sent(),this.log("rtcLeave fail but resolve:",t),this.emit("onError",j),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},e.prototype.setLocalUid=function(t){this.uid=t,this.userMap[t]=this.account},e.prototype.logoutHandler=function(){var t;this.log("logoutHandler success"),null===(t=this.signalController)||void 0===t||t.destroy(),this.signal=null,this.eventBound=!1,this.isConnect=!1,this.uid=0,this.account="",this.userMap={},this.otherClients.clear()},e.prototype.findUid=function(t){var e=this,n=0;return Object.keys(this.userMap).forEach((function(r){e.userMap[r]===t&&(n=Number(r))})),n},e.prototype.sendMessage=function(t,e){var n=this;return new Promise((function(r,i){if(!n.signal||!n.signalController)return i(g);if(!n.signalController.callType)return i(C);if(!n.signalController.channelInfo)return i(p);if(!n.durations.length)return i(T);if(!t)return i("to is invalid");var o={type:n.signalController.callType,channelId:n.signalController.channelInfo.channelId,status:{complete:1,canceled:2,rejected:3,timeout:4,busy:5}[e],durations:n.durations.map((function(t){return a(a({},t),{duration:t.duration?(Date.now()-t.duration)/1e3:null})}))};n.signal.sendG2Msg({attach:o,scene:"p2p",to:t,done:function(e){if(e)return n.log("sendMessage fail:",o,e),i(e);n.log("sendMessage success",o,t),n.emit("onMessageSent",t),r()}})}))},e.prototype.resetRtcState=function(){var t;null===(t=this.rtcController)||void 0===t||t.resetState(),this.uid=0,this.durations=[],this.userMap={},this.log("resetRtcState success")},e.prototype.rtcLeaveAndResetState=function(){return c(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return[4,this.rtcLeave()];case 1:return t.sent(),this.resetRtcState(),this.log("rtcLeaveAndResetState success"),[2]}}))}))},e.prototype.addSignalHooks=function(){var t=this;if(!this.signalController)throw g;this.signalController.inject("afterSignalJoin",(function(e){t.setLocalUid(e.uid)})),this.signalController.inject("afterSignalJoinInGroupCall",(function(e){return c(t,void 0,void 0,(function(){var t;return u(this,(function(n){switch(n.label){case 0:this.setLocalUid(e.uid),n.label=1;case 1:if(n.trys.push([1,3,,4]),!this.rtcController)throw M;return[4,this.rtcController.joinRTCChannel({channelName:e.channelId,type:e.type,uid:this.uid})];case 2:return n.sent(),this.log("joinSignalAndRTC success",e),[3,4];case 3:return t=n.sent(),this.log("joinSignalAndRTC fail:",t),this.rtcLeaveAndResetState(),[2,Promise.reject(t)];case 4:return[2]}}))}))})),this.signalController.inject("afterSignalCreateAndJoin",(function(){t.durations=[{accid:t.userMap[t.uid],duration:Date.now()}]})),this.signalController.inject("callTimeOut",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.emit("onCallingTimeOut","callTimeOut"),[4,this.sendMessage(e,"timeout")];case 1:return t.sent(),[4,this.rtcLeaveAndResetState()];case 2:return t.sent(),[2]}}))}))})),this.signalController.inject("groupCallTimeOut",(function(){return c(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.emit("onCallingTimeOut","groupCallTimeOut"),[4,this.rtcLeaveAndResetState()];case 1:return t.sent(),[2]}}))}))})),this.signalController.inject("groupInviteTimeOut",(function(){return c(t,void 0,void 0,(function(){return u(this,(function(t){return this.emit("onCallingTimeOut","groupInviteTimeOut"),[2]}))}))})),this.signalController.inject("beCallTimeOut",(function(){return c(t,void 0,void 0,(function(){return u(this,(function(t){return this.emit("onCallingTimeOut","beCallTimeOut"),[2]}))}))})),this.signalController.inject("beforeSignalCancel",(function(e){return c(t,void 0,void 0,(function(){var t=this;return u(this,(function(n){return[2,e.find((function(e){return e!==t.userMap[t.uid]}))||""]}))}))})),this.signalController.inject("afterSignalCancel",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return[4,this.sendMessage(e,"canceled")];case 1:return t.sent(),[4,this.rtcLeaveAndResetState()];case 2:return t.sent(),[2]}}))}))})),this.signalController.inject("afterSignalLeave",this.rtcLeave.bind(this)),this.signalController.inject("afterSignalCancelInHangup",this.rtcLeave.bind(this)),this.signalController.inject("afterLeaveFinally",this.resetRtcState.bind(this)),this.signalController.inject("afterHangupFinally",this.resetRtcState.bind(this)),this.signalController.inject("afterSignalAccept",(function(e){return c(t,void 0,void 0,(function(){var t=this;return u(this,(function(n){return this.uid=Number(e.members.find((function(e){return e.accid===t.account})).uid),e.members.forEach((function(e){t.userMap[e.uid]||(t.userMap[e.uid]=e.accid)})),[2]}))}))})),this.signalController.inject("afterSignalAcceptInGroupCall",(function(e){return c(t,void 0,void 0,(function(){var t=this;return u(this,(function(n){switch(n.label){case 0:if(this.uid=Number(e.members.find((function(e){return e.accid===t.account})).uid),e.members.forEach((function(e){t.userMap[e.uid]||(t.userMap[e.uid]=e.accid)})),!this.rtcController)throw M;return[4,this.rtcController.joinRTCChannel({channelName:e.channelId,type:e.type,uid:this.uid})];case 1:return n.sent(),[2]}}))}))})),this.signalController.inject("whenSignalRoomJoin",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){return this.userMap[e.uid]=e.from,[2]}))}))})),this.signalController.inject("whenSignalRoomClose",(function(){return c(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return[4,this.rtcLeaveAndResetState()];case 1:return t.sent(),this.emit("onCallEnd"),[2]}}))}))})),this.signalController.inject("whenSignalCancel",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){return this.emit("onUserCancel",e),[2]}))}))})),this.signalController.inject("whenSignalAccept",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:if(this.emit("onUserAccept",e.from),!this.rtcController)throw M;return[4,this.rtcController.joinRTCChannel({channelName:e.channelId,type:e.type,uid:this.uid})];case 1:return t.sent(),this.durations.push({accid:e.from,duration:Date.now()}),[4,this.signal.signalingControl({channelId:e.channelId,account:e.from,attachExt:JSON.stringify({cid:1})})];case 2:return t.sent(),[2]}}))}))})),this.signalController.inject("whenSignalAcceptInGroupCall",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){return this.emit("onUserAccept",e.from),[2]}))}))})),this.signalController.inject("whenSignalInvited",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){return this.emit("onInvited",{invitor:e.invitor,userIds:e.userIds,isFromGroup:e.isFromGroup,groupId:e.groupID,attachment:e.attachment,type:e.type}),[2]}))}))})),this.signalController.inject("whenSignalControl",this.controlHandler.bind(this)),this.signalController.inject("whenSignalRejectIsValid",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){return Number(e.event.requestId)!==Number(e.requestId)||e.to!==this.account?[2,!1]:[2,!0]}))}))})),this.signalController.inject("whenSignalReject",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return"601"!==e.attachExt?[3,2]:(this.emit("onUserBusy",e.from),[4,this.sendMessage(e.from,"busy")]);case 1:return t.sent(),[3,4];case 2:return this.emit("onUserReject",e.from),[4,this.sendMessage(e.from,"rejected")];case 3:t.sent(),t.label=4;case 4:return[4,this.rtcLeaveAndResetState()];case 5:return t.sent(),[2]}}))}))})),this.signalController.inject("whenSignalRejectInGroupCall",(function(e){return c(t,void 0,void 0,(function(){return u(this,(function(t){return"601"===e.attachExt?this.emit("onUserBusy",e.from):this.emit("onUserReject",e.from),[2]}))}))})),this.signalController.inject("whenSignalRejectOtherClient",(function(){return c(t,void 0,void 0,(function(){return u(this,(function(t){return this.resetRtcState(),this.emit("onOtherClientReject"),[2]}))}))})),this.signalController.inject("whenSignalAcceptOtherClient",(function(){return c(t,void 0,void 0,(function(){return u(this,(function(t){return this.resetRtcState(),this.emit("onOtherClientAccept"),[2]}))}))})),this.signalController.inject("onSignalChannelsSyncNotify",(function(e){e.forEach((function(e){var n,r=e.channelId,i=e.members;!t.otherClients.size&&i.some((function(e){return e.accid===t.account}))&&(null===(n=t.signalController)||void 0===n||n.leave({channelId:r}))}))})),this.signalController.inject("signalInviteFail",this.rtcLeaveAndResetState.bind(this)),this.signalController.inject("signalInviteFailInGroupCall",this.rtcLeaveAndResetState.bind(this)),this.signalController.inject("signalAcceptFail",this.rtcLeaveAndResetState.bind(this)),this.signalController.inject("errorEvent",(function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return c(t,void 0,void 0,(function(){return u(this,(function(t){return this.emit.apply(this,f(["onError"],e)),[2]}))}))}))},e.prototype.addRtcListeners=function(){var t=this;if(!this.rtcController)throw M;this.rtcController.on("onJoinChannel",(function(e){t.emit("onJoinChannel",a(a({},e),{userId:t.account}))})),this.rtcController.client.on("peer-online",(function(e){t.roomJoinHandler(e)})),this.rtcController.client.on("peer-leave",(function(e){t.leaveHandler(e)})),this.rtcController.client.on("stream-added",(function(e){return c(t,void 0,void 0,(function(){var t,n;return u(this,(function(r){switch(r.label){case 0:if(this.log("stream-added:",e),!this.rtcController)return[2,Promise.reject(M)];t=e.stream,this.rtcController.addStream(t),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.rtcController.rtcSubscribe(t,{audio:!0,video:!0})];case 2:return r.sent(),[3,4];case 3:return n=r.sent(),this.log("stream-added fail: ",n),[3,4];case 4:return[2]}}))}))})),this.rtcController.client.on("stream-removed",(function(e){return c(t,void 0,void 0,(function(){var t,n,r;return u(this,(function(i){try{if(!this.signalController)throw g;if(!this.rtcController)throw M;this.log("stream-removed:","callType:",this.signalController.callType,e),t=e.stream,n=t.getId(),t.stop(),this.log("stream-removed：停止订阅流，更新流"),this.rtcController.updateStream(t),r=this.userMap[n],this.emit("onAudioAvailable",{userId:r,uid:n,available:t.audio}),2===this.signalController.callType&&this.emit("onCameraAvailable",{userId:r,uid:n,available:t.video})}catch(t){this.log("stream-removed fail: ",t)}return[2]}))}))})),this.rtcController.client.on("stream-subscribed",(function(e){return c(t,void 0,void 0,(function(){var t,n,r,i,o;return u(this,(function(s){switch(s.label){case 0:if(!this.rtcController)return[2,Promise.reject(M)];t=e.stream,n=t.getId(),r=this.userMap[n],i=this.rtcController.findRemoteView(n),s.label=1;case 1:if(s.trys.push([1,3,,4]),!this.signalController)throw g;return this.log("stream-subscribed:","callType:",this.signalController.callType,e),this.emit("onAudioAvailable",{userId:r,uid:n,available:t.audio}),2===this.signalController.callType&&this.emit("onCameraAvailable",{userId:r,uid:n,available:t.video}),[4,this.rtcController.startStreamPreview(t,"remote",i)];case 2:return s.sent(),this.log("startRemoteStreamPreview success",t,i),[3,4];case 3:return o=s.sent(),this.log("stream-subscribed fail: ",t,i,o),[3,4];case 4:return[2]}}))}))})),this.rtcController.client.on("mute-video",(function(e){var n=t.userMap[e.uid];t.emit("onVideoMuted",{userId:n,muted:!0})})),this.rtcController.client.on("unmute-video",(function(e){var n=t.userMap[e.uid];t.emit("onVideoMuted",{userId:n,muted:!1})})),this.rtcController.client.on("mute-audio",(function(e){var n=t.userMap[e.uid];t.emit("onAudioMuted",{userId:n,muted:!0})})),this.rtcController.client.on("unmute-audio",(function(e){var n=t.userMap[e.uid];t.emit("onAudioMuted",{userId:n,muted:!1})})),this.rtcController.client.on("network-quality",(function(e){var n={};e.forEach((function(e){var r=t.userMap[e.uid];r&&(n[r]={uplinkNetworkQuality:e.uplinkNetworkQuality,downlinkNetworkQuality:e.downlinkNetworkQuality})})),t.emit("onUserNetworkQuality",n)})),this.rtcController.client.on("channel-closed",(function(){t.emit("onDisconnect")}))},e.prototype.roomJoinHandler=function(t){var e=this.userMap[t.uid];this.log("roomJoinHandler:",e,t),this.emit("onUserEnter",e)},e.prototype.leaveHandler=function(t){return c(this,void 0,void 0,(function(){var e,n;return u(this,(function(r){return this.log("leaveHandler:",t),this.rtcController?(e=t.uid,this.rtcController.removeStream(e),n=this.userMap[e],delete this.userMap[e],this.emit("onUserLeave",n),[2]):[2,Promise.reject(M)]}))}))},e.prototype.controlHandler=function(t){return c(this,void 0,void 0,(function(){var e,n,r;return u(this,(function(i){switch(i.label){case 0:this.log("controlHandler start"),i.label=1;case 1:if(i.trys.push([1,8,,9]),!this.signalController)throw g;if(!this.signalController.channelInfo)throw p;if(!this.signalController.callType)throw C;if(!this.rtcController)throw M;this.log("controlHandler: ","channelInfo: ",this.signalController.channelInfo,"callType: ",this.signalController.callType,t),e=void 0;try{e=JSON.parse(t.attachExt)}catch(t){e={}}return 1!==e.cid?[3,3]:[4,this.rtcController.joinRTCChannel({channelName:this.signalController.channelInfo.channelId,type:this.signalController.callType,uid:this.uid})];case 2:return i.sent(),this.signalController.isGroupCall||(this.durations=[{accid:this.userMap[this.uid],duration:Date.now()},{accid:t.from,duration:Date.now()}]),this.log("controlHandler joinRTCChannel success",this.durations),[3,7];case 3:if(2!==e.cid)return[3,7];if(1!==e.type)return[3,7];i.label=4;case 4:return i.trys.push([4,6,,7]),this.emit("onCallTypeChange",1),[4,this.rtcController.enableLocalVideo(!1)];case 5:return i.sent(),this.log("controlHandler switchCallType success"),[3,7];case 6:return n=i.sent(),this.log("controlHandler switchCallType fail: ",n),[3,7];case 7:return this.log("controlHandler success: "),[3,9];case 8:throw r=i.sent(),this.log("controlHandler fail: ",r),this.rtcLeaveAndResetState(),r;case 9:return[2]}}))}))},e.getInstance=function(t){var n=(void 0===t?{debug:!0}:t).debug,r=void 0===n||n;return this.instance||(this.instance=new e({debug:r})),this.instance},e.version="1.3.2",e.instance=null,e}(q);exports.SignalController=F,exports.default=B;
