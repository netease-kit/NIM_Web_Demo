import e from"../assets/sdk/NIM_Web_SDK_v8.1.0.js";import t from"../assets/sdk/NIM_Web_WebRTC2_v3.7.0.js";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function s(e,t){function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}var i=function(){return(i=Object.assign||function(e){for(var t,n=1,s=arguments.length;n<s;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function r(e,t,n,s){return new(n||(n=Promise))((function(i,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))}function o(e,t){var n,s,i,r,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,s&&(i=2&r[0]?s.return:r[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,r[1])).done)return i;switch(s=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return o.label++,{value:r[1],done:!1};case 5:o.label++,s=r[1],r=[0];continue;case 7:r=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){o=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){o.label=r[1];break}if(6===r[0]&&o.label<i[1]){o.label=i[1],i=r;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(r);break}i[2]&&o.ops.pop(),o.trys.pop();continue}r=t.call(e,o)}catch(e){r=[6,e],s=0}finally{n=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}function a(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var s,i,r=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(e){i={error:e}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}return o}function c(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(a(arguments[t]));return e}var l,u={code:"100",message:"未知错误"},h={code:"101",message:"disconnect failed"},d={code:"102",message:"signal is null"},f={code:"103",message:"channelInfo is null"},p={code:"104",message:"client is null"},v={code:"105",message:"stream is null"},g={code:"106",message:"callType is null"},m={code:"107",message:"invite all failed"},y={code:"109",message:"groupInvite part failed"},I={code:"110",message:"cancel part failed"},b={code:"111",message:"signal leave failed"},w={code:"112",message:"G2 RTC leave failed"},C={code:"113",message:"durations is empty"},S={code:"114",message:"deviceId is null"},T={code:"115",message:"invotorChannelInfo is null"};!function(e){e[e.idle=0]="idle",e[e.calling=1]="calling",e[e.called=2]="called",e[e.inCall=3]="inCall"}(l||(l={}));var j,P=(function(e){var t=Object.prototype.hasOwnProperty,n="~";function s(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function r(e,t,s,r,o){if("function"!=typeof s)throw new TypeError("The listener must be a function");var a=new i(s,r||e,o),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function a(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(n=!1)),a.prototype.eventNames=function(){var e,s,i=[];if(0===this._eventsCount)return i;for(s in e=this._events)t.call(e,s)&&i.push(n?s.slice(1):s);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},a.prototype.listeners=function(e){var t=n?n+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var i=0,r=s.length,o=new Array(r);i<r;i++)o[i]=s[i].fn;return o},a.prototype.listenerCount=function(e){var t=n?n+e:e,s=this._events[t];return s?s.fn?1:s.length:0},a.prototype.emit=function(e,t,s,i,r,o){var a=n?n+e:e;if(!this._events[a])return!1;var c,l,u=this._events[a],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,s),!0;case 4:return u.fn.call(u.context,t,s,i),!0;case 5:return u.fn.call(u.context,t,s,i,r),!0;case 6:return u.fn.call(u.context,t,s,i,r,o),!0}for(l=1,c=new Array(h-1);l<h;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var d,f=u.length;for(l=0;l<f;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),h){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,s);break;case 4:u[l].fn.call(u[l].context,t,s,i);break;default:if(!c)for(d=1,c=new Array(h-1);d<h;d++)c[d-1]=arguments[d];u[l].fn.apply(u[l].context,c)}}return!0},a.prototype.on=function(e,t,n){return r(this,e,t,n,!1)},a.prototype.once=function(e,t,n){return r(this,e,t,n,!0)},a.prototype.removeListener=function(e,t,s,i){var r=n?n+e:e;if(!this._events[r])return this;if(!t)return o(this,r),this;var a=this._events[r];if(a.fn)a.fn!==t||i&&!a.once||s&&a.context!==s||o(this,r);else{for(var c=0,l=[],u=a.length;c<u;c++)(a[c].fn!==t||i&&!a[c].once||s&&a[c].context!==s)&&l.push(a[c]);l.length?this._events[r]=1===l.length?l[0]:l:o(this,r)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&o(this,t)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,e.exports=a}(j={exports:{}},j.exports),j.exports),k=function(e){function t(t){var n=t.debug,s=e.call(this)||this;return s.log=null,s.debug=!0,s.debug=n,s.log=function(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(e){var s=new Date,i=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+" "+s.getHours()+":"+s.getMinutes()+":"+s.getSeconds();console.log.apply(console,c(["[NRTCCalling Message 1.0.1 "+i+"]: "],t))}}}(n),s}return s(t,e),t}(P),M=function(e){function n(n){var s=e.call(this,n)||this;return s.client=null,s.webrtc=t,s.appKey="",s.localStream=null,s.remoteStreams=[],s.localView=void 0,s.remoteViews=[],s.microphoneId="",s.cameraId="",s.speakerId="",s.audioEnabled=!1,s.videoEnabled=!1,s.getTokenFunc=null,s.resolution=8,s.frameRate=3,s.quality="speech_low_quality",s}return s(n,e),n.prototype.setupAppKey=function(e){var n=e.appKey,s=e.resolution,i=e.frameRate,r=e.quality;this.client||(this.appKey=n,this.client=t.createClient({appkey:this.appKey,debug:this.debug}),s&&(this.resolution=s),i&&(this.frameRate=i),r&&(this.quality=r),this.log("setupAppKey success"))},n.prototype.setTokenService=function(e){this.getTokenFunc=e},n.prototype.setupLocalView=function(e){e&&(this.localView=e,this.log("setupLocalView set view success",e))},n.prototype.setupRemoteView=function(e,t){this.remoteViews.every((function(t){return t.uid!==e}))?this.remoteViews.push({uid:e,view:t}):this.remoteViews=this.remoteViews.map((function(n){return n.uid===e?i(i({},n),{view:t}):i({},n)}))},n.prototype.selectSpeakers=function(e){var t;return r(this,void 0,void 0,(function(){var n,s,i,r,a,c;return o(this,(function(o){switch(o.label){case 0:if(o.trys.push([0,5,,6]),!this.client)throw p;if(!(n=null===(t=this.client.adapterRef)||void 0===t?void 0:t.audioHelperMap))throw u;if(!e)throw S;for(i in s=[],n)s.push(i);r=0,o.label=1;case 1:return r<s.length?(a=s[r],n[a]&&n[a].audioDomHelper&&n[a].audioDomHelper.audioDom?[4,this._selectSpeakers(n[a].audioDomHelper.audioDom,e)]:[3,3]):[3,4];case 2:o.sent(),o.label=3;case 3:return r++,[3,1];case 4:return this.log("selectSpeakers success",e),[3,6];case 5:return c=o.sent(),this.log("selectSpeakers fail: ",c,e),[2,Promise.reject(c)];case 6:return[2]}}))}))},n.prototype.getDevices=function(){return r(this,void 0,void 0,(function(){var e,n,s,r,a,c,l=this;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,t.getDevices()];case 1:for(a in e=o.sent(),n={audioIn:"microphoneId",audioOut:"speakerId",video:"cameraId"},s={},r=function(t){e.hasOwnProperty(t)&&(s[t]=e[t].map((function(e){return l[n[t]]===e.deviceId?i(i({},e),{active:!0}):i({},e)})))},e)r(a);return this.log("getDevices success",s),[2,s];case 2:return c=o.sent(),this.log("getDevices fail: ",c),[2,Promise.reject(c)];case 3:return[2]}}))}))},n.prototype.switchDevice=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(s){switch(s.label){case 0:switch(s.trys.push([0,8,,9]),e){case"microphoneId":return[3,1];case"cameraId":return[3,3];case"speakerId":return[3,5]}return[3,7];case 1:return this.microphoneId===t?[2,Promise.resolve()]:[4,this.muteLocalAudio(this.audioEnabled,t)];case 2:return s.sent(),[3,7];case 3:return this.cameraId===t?[2,Promise.resolve()]:[4,this.enableLocalVideo(this.videoEnabled,t)];case 4:return s.sent(),[3,7];case 5:return this.speakerId===t?[2,Promise.resolve()]:[4,this.selectSpeakers(t)];case 6:return s.sent(),[3,7];case 7:return this.log("switchDevice success",e,t),[3,9];case 8:return n=s.sent(),this.log("switchDevice fail: ",n,e,t),[2,Promise.reject(n)];case 9:return[2]}}))}))},n.prototype.setAudioMute=function(e,t){return r(this,void 0,void 0,(function(){var n,s;return o(this,(function(i){switch(i.label){case 0:if(!(n=this.remoteStreams.find((function(e){return e.getId()===t}))))return this.log("setAudioMute fail: ",v,t),[2,Promise.reject(v)];i.label=1;case 1:return i.trys.push([1,6,,7]),e?[4,n.muteAudio()]:[3,3];case 2:return i.sent(),[3,5];case 3:return[4,n.unmuteAudio()];case 4:i.sent(),i.label=5;case 5:return this.log("setAudioMute success",e,n),[3,7];case 6:return s=i.sent(),this.log("setAudioMute fail: ",s),[2,Promise.reject(s)];case 7:return[2]}}))}))},n.prototype.joinRTCChannel=function(e){var t=e.channelName,n=e.type,s=e.uid;return r(this,void 0,void 0,(function(){var e,i;return o(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,6,,7]),!this.client)throw p;return e="",this.getTokenFunc?[4,this.getTokenFunc(s)]:[3,2];case 1:e=r.sent(),this.log("getToken success",e),r.label=2;case 2:return[4,this.client.join({channelName:t,uid:s,token:e})];case 3:return r.sent(),[4,this.initLocalStream({type:n,uid:s})];case 4:return r.sent(),[4,this.client.publish(this.localStream)];case 5:return r.sent(),this.log("joinRTCChannel success"),[3,7];case 6:return i=r.sent(),this.log("joinRTCChannel fail:",i),[2,Promise.reject(i)];case 7:return[2]}}))}))},n.prototype.initLocalStream=function(e){var n,s,i,a=e.type,c=e.uid;return r(this,void 0,void 0,(function(){var e,r,l,u,h;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),this.localStream=t.createStream({uid:c,audio:!0,video:2===a,screen:!1}),this.log("localStream create success"),this.localStream.setVideoProfile({resolution:this.resolution,frameRate:this.frameRate}),this.localStream.setAudioProfile(this.quality),[4,this.localStream.init()];case 1:return o.sent(),this.log("localStream init success"),[4,this.getDevices()];case 2:return e=o.sent(),r=e.audioIn,l=e.audioOut,u=e.video,this.microphoneId=(null===(n=r[0])||void 0===n?void 0:n.deviceId)||"",this.cameraId=(null===(s=u[0])||void 0===s?void 0:s.deviceId)||"",this.speakerId=(null===(i=l[0])||void 0===i?void 0:i.deviceId)||"",[4,this.startStreamPreview(this.localStream,"local",this.localView)];case 3:return o.sent(),this.log("startLocalStreamPreview success",this.localStream,this.localView),this.log("initLocalStream success"),[3,5];case 4:return h=o.sent(),this.log("initLocalStream fail:",h),[2,Promise.reject(h)];case 5:return[2]}}))}))},n.prototype.rtcSubscribe=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(s){switch(s.label){case 0:e.setSubscribeConfig(t),s.label=1;case 1:if(s.trys.push([1,3,,4]),!this.client)throw p;return[4,this.client.subscribe(e)];case 2:return s.sent(),this.log("rtcSubscribe success"),[3,4];case 3:return n=s.sent(),this.log("rtcSubscribe fail:",n),[2,Promise.reject(n)];case 4:return[2]}}))}))},n.prototype.rtcUnSubscribe=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(s){switch(s.label){case 0:e.setSubscribeConfig(t),s.label=1;case 1:if(s.trys.push([1,3,,4]),!this.client)throw p;return[4,this.client.unsubscribe(e)];case 2:return s.sent(),this.log("rtcUnSubscribe success"),[3,4];case 3:return n=s.sent(),this.log("rtcUnSubscribe fail:",n),[2,Promise.reject(n)];case 4:return[2]}}))}))},n.prototype.rtcLeave=function(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:if(t.trys.push([0,2,,3]),!this.client)throw p;return[4,this.client.leave()];case 1:return t.sent(),[3,3];case 2:return e=t.sent(),[2,Promise.reject(e)];case 3:return[2]}}))}))},n.prototype.startStreamPreview=function(e,t,n){return r(this,void 0,void 0,(function(){var s,i;return o(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,e.play(n)];case 1:return r.sent(),this.log("startStreamPreview success",{stream:e,type:t,view:n}),n&&(s={width:n.clientWidth,height:n.clientHeight,cut:!0},e["local"===t?"setLocalRenderMode":"setRemoteRenderMode"](s),this.log("setLocalRenderMode success",{params:s,type:t})),[3,3];case 2:return i=r.sent(),this.log("startStreamPreview fail: ",i),[2,Promise.reject(i)];case 3:return[2]}}))}))},n.prototype.enableLocalVideo=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,4,,5]),!this.localStream)throw v;return[4,this.localStream[e?"open":"close"]({type:"video",deviceId:t})];case 1:return s.sent(),this.videoEnabled=e,t&&(this.cameraId=t),e?[4,this.startStreamPreview(this.localStream,"local",this.localView)]:[3,3];case 2:s.sent(),s.label=3;case 3:return this.log("_enableLocalVideo success:",e,t),[3,5];case 4:return n=s.sent(),this.log("_enableLocalVideo fail:",e,t,n),[2,Promise.reject(n)];case 5:return[2]}}))}))},n.prototype.muteLocalAudio=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,2,,3]),!this.localStream)throw v;return[4,this.localStream[e?"close":"open"]({type:"audio",deviceId:t})];case 1:return s.sent(),this.audioEnabled=!e,t&&(this.microphoneId=t),this.log("_muteLocalAudio success:",e,t),[3,3];case 2:return n=s.sent(),this.log("_muteLocalAudio fail:",e,t,n),[2,Promise.reject(n)];case 3:return[2]}}))}))},n.prototype.addStream=function(e){var t=e.getId();this.remoteStreams.some((function(e){return e.getId()===t}))?(this.log("stream-added：订阅的流已存在，更新流"),this.updateStream(e)):(this.log("stream-added：新增需要订阅的流"),this.remoteStreams.push(e))},n.prototype.updateStream=function(e){var t=e.getId();this.remoteStreams=this.remoteStreams.map((function(n){return n.getId()===t?e:n}))},n.prototype.removeStream=function(e){this.remoteStreams=this.remoteStreams.filter((function(t){return t.getId()!==e}))},n.prototype.findRemoteView=function(e){return(this.remoteViews.find((function(t){return t.uid===e}))||{view:void 0}).view},n.prototype.destroy=function(){this.localStream=null,this.remoteStreams=[],this.localView=void 0,this.remoteViews=[],this.audioEnabled=!1,this.videoEnabled=!1,this.microphoneId="",this.cameraId="",this.speakerId="",this.log("rtcController destroy success")},n.prototype._selectSpeakers=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(s){switch(s.label){case 0:if(e&&void 0===e.sinkId)return[2];s.label=1;case 1:return s.trys.push([1,3,,4]),[4,e.setSinkId(t)];case 2:return s.sent(),this.speakerId=t,[3,4];case 3:return n=s.sent(),[2,Promise.reject(n)];case 4:return[2]}}))}))},n}(k),E=function(){return Math.ceil(1e5*Math.random())+""},L=function(t){function n(e){var n=(void 0===e?{debug:!0}:e).debug,s=void 0===n||n,i=t.call(this,{debug:s})||this;return i.signal=null,i.isConnect=!1,i.channelInfo=null,i.callingUserIds=[],i.requestId="",i.callType=null,i.account="",i.uid="",i.invitorChannelInfo=null,i.isGroupCall=!1,i.callStatus=l.idle,i.durations=[],i.userMap={},i.callTimeout=void 0,i.rejectTimeout=void 0,i.eventBound=!1,i.rtc=new M({debug:s}),i}return s(n,t),n.prototype.setupAppKey=function(e){return this.rtc.setupAppKey(e)},n.prototype.login=function(t){var n=this,s=t.account,r=t.token,o=t.success,a=t.failed,c=function(e,t){var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(s=Object.getOwnPropertySymbols(e);i<s.length;i++)t.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(e,s[i])&&(n[s[i]]=e[s[i]])}return n}(t,["account","token","success","failed"]);return new Promise((function(t,l){var u=i(i({},c),{appKey:n.rtc.appKey,account:s,token:r,debug:n.debug,onconnect:function(){var e;n.log("login success"),null===(e=c.onconnect)||void 0===e||e.call(c),n.isConnect=!0,n.account=s,n.signal.signalingSync(),null==o||o(),t()},onerror:function(e){var t;n.log("login fail:",e),null===(t=c.onerror)||void 0===t||t.call(c),null==a||a(e),l(e)}});n.signal=e.NIM.getInstance(u),n.eventBound||(n.eventBound=!0,n.addEventListener())}))},n.prototype.logout=function(e){var t,n;return r(this,void 0,void 0,(function(){var s;return o(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),!this.isConnect)throw h;if(!this.signal)throw d;return[4,this.signal.disconnect()];case 1:return i.sent(),this.removeLocalUid(),this.log("logout success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,3];case 2:return s=i.sent(),this.log("logout fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,h),[2,Promise.reject(h)];case 3:return[2]}}))}))},n.prototype.setTokenService=function(e){return this.rtc.setTokenService(e)},n.prototype.addDelegate=function(e,t){this.on(e,t)},n.prototype.removeDelegate=function(e){this.off(e)},n.prototype.call=function(e){var t,n;return r(this,void 0,void 0,(function(){var s,i,a,c=this;return o(this,(function(u){switch(u.label){case 0:if(u.trys.push([0,5,,6]),!this.signal)throw d;return this.channelInfo?[3,3]:[4,this.signalCreate({type:e.type})];case 1:return s=u.sent(),[4,this.signal.signalingJoin({channelId:s.channelId,offlineEnabled:!0})];case 2:i=u.sent(),this.setLocalUid(i.members[0].uid),this.log("signalingJoin success！"),u.label=3;case 3:return this.callStatus=l.calling,this.isGroupCall=!1,this.durations=[{accid:this.userMap[this.uid],duration:Date.now()}],this.callingUserIds=[e.userId],this.requestId=E(),[4,this.signalInvite(e.userId)];case 4:return u.sent(),this.log("call success"),null===(t=e.success)||void 0===t||t.call(e),void 0!==this.callTimeout&&setTimeout((function(){return r(c,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:if(this.callStatus!==l.calling)return[3,7];n.label=1;case 1:return n.trys.push([1,3,4,7]),[4,this.signalCancel()];case 2:return n.sent(),this.log("signalInvite timeout cancel success",this.callTimeout),[3,7];case 3:return t=n.sent(),this.log("signalInvite timeout cancel fail: ",t,this.callTimeout),[3,7];case 4:return this.emit("onCallingTimeOut"),[4,this.sendMessage(e.userId,"timeout")];case 5:return n.sent(),[4,this.destroy()];case 6:return n.sent(),[7];case 7:return[2]}}))}))}),this.callTimeout),[3,6];case 5:return a=u.sent(),this.log("call fail:",a),null===(n=e.failed)||void 0===n||n.call(e,a),[2,Promise.reject(a)];case 6:return[2]}}))}))},n.prototype.groupCall=function(e){var t,n;return r(this,void 0,void 0,(function(){var s,i=this;return o(this,(function(a){switch(a.label){case 0:if(a.trys.push([0,5,,6]),!this.signal)throw d;return this.channelInfo?[3,3]:[4,this.signalCreate({type:e.type})];case 1:return a.sent(),[4,this.joinSignalAndRTC()];case 2:a.sent(),a.label=3;case 3:return this.callStatus=l.calling,this.isGroupCall=!0,this.callingUserIds=c(e.userIds),this.requestId=E(),[4,this.signalGroupInvite({userIds:e.userIds,groupId:e.groupId})];case 4:return a.sent(),this.log("groupCall success"),null===(t=e.success)||void 0===t||t.call(e),void 0!==this.callTimeout&&setTimeout((function(){return r(i,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:if(this.callStatus!==l.calling)return[3,6];t.label=1;case 1:return t.trys.push([1,3,4,6]),[4,Promise.all([this.signalCancel(),this.rtcLeave()])];case 2:return t.sent(),this.log("signalGroupInvite timeout cancel success",this.callStatus),[3,6];case 3:return e=t.sent(),this.log("signalGroupInvite timeout cancel fail: ",e,this.callStatus),[3,6];case 4:return this.emit("onCallingTimeOut"),[4,this.destroy()];case 5:return t.sent(),[7];case 6:return[2]}}))}))}),this.callTimeout),[3,6];case 5:return s=a.sent(),this.log("groupCall fail",s),null===(n=e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 6:return[2]}}))}))},n.prototype.cancel=function(e){var t,n;return r(this,void 0,void 0,(function(){var s,i,r=this;return o(this,(function(o){switch(o.label){case 0:if(o.trys.push([0,5,,6]),!this.signal)throw d;if(!this.channelInfo)throw f;return s="",this.isGroupCall||(s=this.callingUserIds.find((function(e){return e!==r.userMap[r.uid]}))||""),[4,this.signalCancel()];case 1:return o.sent(),this.isGroupCall?[3,4]:[4,this.sendMessage(s,"canceled")];case 2:return o.sent(),[4,this.destroy()];case 3:o.sent(),o.label=4;case 4:return this.log("cancel success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,6];case 5:return i=o.sent(),this.log("cancel fail",i),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,i),[2,Promise.reject(i)];case 6:return[2]}}))}))},n.prototype.accept=function(e){var t,n;return r(this,void 0,void 0,(function(){var s;return o(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),!this.signal)throw d;return[4,this.acceptSignal()];case 1:return i.sent(),this.callStatus=l.inCall,this.log("accept success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,3];case 2:return s=i.sent(),this.log("accept fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 3:return[2]}}))}))},n.prototype.reject=function(e){var t,n;return r(this,void 0,void 0,(function(){var s;return o(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,3,4]),!this.invitorChannelInfo)throw T;return[4,this.rejectCall(!1,{channelId:this.invitorChannelInfo.channelId,account:this.invitorChannelInfo.from,requestId:this.invitorChannelInfo.requestId})];case 1:return i.sent(),this.log("reject success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,4];case 2:return s=i.sent(),this.log("reject fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 3:return this.invitorChannelInfo=null,[7];case 4:return[2]}}))}))},n.prototype.leave=function(e){var t,n;return r(this,void 0,void 0,(function(){var s;return o(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,3,4]),!this.signal)throw d;if(!this.channelInfo)throw f;return[4,Promise.all([this.signalLeave(),this.rtcLeave()])];case 1:return i.sent(),this.log("leave success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,4];case 2:return s=i.sent(),this.log("leave fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 3:return this.resetChannel(),[7];case 4:return[2]}}))}))},n.prototype.hangup=function(e){var t,n;return r(this,void 0,void 0,(function(){var s;return o(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,3,4,5]),!this.signal)throw d;if(!this.channelInfo)throw f;return[4,Promise.all([this.signalCancel(),this.rtcLeave()])];case 1:return i.sent(),[4,this.signalClose()];case 2:return i.sent(),this.log("hangup success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,5];case 3:return s=i.sent(),this.log("hangup fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 4:return this.resetChannel(),[7];case 5:return[2]}}))}))},n.prototype.enableLocalVideo=function(e){return this.rtc.enableLocalVideo(e)},n.prototype.muteLocalAudio=function(e){return this.rtc.muteLocalAudio(e)},n.prototype.switchCallType=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,6,,7]),1!==e)throw"sorry，目前仅支持视频切换为音频";if(!this.signal)throw d;if(!this.channelInfo)throw f;s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this.rtc.enableLocalVideo(!1)];case 2:return s.sent(),[3,4];case 3:return t=s.sent(),this.log("enableLocalVideo in switchCallType fail but resolve",t),[3,4];case 4:return[4,this.signal.signalingControl({channelId:this.channelInfo.channelId,account:"",attachExt:JSON.stringify({cid:2,type:1})})];case 5:return s.sent(),this.log("switchCallType success"),[3,7];case 6:return n=s.sent(),this.log("switchCallType fail: ",n),[2,Promise.reject(n)];case 7:return[2]}}))}))},n.prototype.setAudioMute=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(s){return n=this.findUid(t),[2,this.rtc.setAudioMute(e,n)]}))}))},n.prototype.setupLocalView=function(e){return this.rtc.setupLocalView(e)},n.prototype.setupRemoteView=function(e,t){var n=this.findUid(e);return this.rtc.setupRemoteView(n,t)},n.prototype.selectSpeakers=function(e){return this.rtc.selectSpeakers(e)},n.prototype.getDevices=function(){return this.rtc.getDevices()},n.prototype.switchDevice=function(e,t){return this.rtc.switchDevice(e,t)},n.prototype.setCallTimeout=function(e){this.callTimeout=this.rejectTimeout=e},n.prototype.getRoomInfo=function(){return r(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:if(n.trys.push([0,2,,3]),!this.channelInfo)throw f;if(!this.signal)throw d;return[4,this.signal.signalingGetChannelInfo({channelName:this.channelInfo.channelName})];case 1:return e=n.sent(),this.log("getRoomInfo success"),[2,i(i({},e),{uid:this.uid})];case 2:return t=n.sent(),this.log("getRoomInfo fail: ",t),[2,Promise.reject(t)];case 3:return[2]}}))}))},n.prototype.getSdkInstance=function(){return{signal:this.signal,rtcClient:this.rtc.client,WebRTC2:this.rtc.webrtc}},n.prototype.signalCreate=function(e){var t=e.type;return r(this,void 0,void 0,(function(){var e,n;return o(this,(function(s){switch(s.label){case 0:this.callType||(this.callType=t),s.label=1;case 1:return s.trys.push([1,3,,4]),e=this,[4,this.signal.signalingCreate({type:t})];case 2:return e.channelInfo=s.sent(),this.log("signalingCreate Success","channelInfo:",this.channelInfo,"callType:",this.callType),[2,this.channelInfo];case 3:return n=s.sent(),this.log("signalingCreate failed:",n,"callType:",this.callType),[2,Promise.reject(n)];case 4:return[2]}}))}))},n.prototype.signalInvite=function(e){return r(this,void 0,void 0,(function(){var t,n,s,i;return o(this,(function(r){switch(r.label){case 0:if(!this.channelInfo)return[2,Promise.reject(f)];r.label=1;case 1:r.trys.push([1,6,,8]),t=JSON.stringify({callType:0}),n={channelId:this.channelInfo.channelId,offlineEnabled:!0,account:e,requestId:this.requestId,pushInfo:{pushTitle:"邀请通知",pushContent:"你收到了邀请",pushPayload:{},needPush:!0,needBadge:!0},attachExt:t},this.log("signalingInvite in call",n),r.label=2;case 2:return r.trys.push([2,4,,5]),[4,this.signal.signalingInvite(n)];case 3:return r.sent(),[3,5];case 4:if(s=r.sent(),!/OFFLINE/i.test(null==s?void 0:s.message))throw s;return[3,5];case 5:return this.log("signalInvite success！"),[3,8];case 6:return i=r.sent(),this.log("signalInvite fail:",{channelId:this.channelInfo.channelId,requestId:this.requestId},i),this.callingUserIds=this.callingUserIds.filter((function(t){return t!==e})),[4,this.destroy()];case 7:return r.sent(),[2,Promise.reject(i)];case 8:return[2]}}))}))},n.prototype.signalGroupInvite=function(e){return r(this,void 0,void 0,(function(){var t,n,s,i=this;return o(this,(function(r){switch(r.label){case 0:return this.channelInfo?(t=JSON.stringify({callType:1,callUserList:this.callingUserIds,groupID:void 0===e.groupId?null:e.groupId}),[4,Promise.allSettled(e.userIds.map((function(e){var n={channelId:i.channelInfo.channelId,offlineEnabled:!0,account:e,requestId:i.requestId,pushInfo:{pushTitle:"邀请通知",pushContent:"你收到了邀请",pushPayload:{},needPush:!0,needBadge:!0},attachExt:t};return i.log("signalingInvite in groupCall",n),i.signal.signalingInvite(n).then((function(){return Promise.resolve()})).catch((function(e){return/OFFLINE/i.test(null==e?void 0:e.message)?Promise.resolve():Promise.reject(e)}))})))]):[2,Promise.reject(f)];case 1:return(n=r.sent()).every((function(e){return"rejected"===e.status}))?(this.log("signalGroupInvite fail",n),[4,this.destroy()]):[3,3];case 2:return r.sent(),[2,Promise.reject(m)];case 3:return(s=e.userIds.filter((function(e,t){return"rejected"===n[t].status}))).length&&(this.log("signalGroupInvite part fail:",s),this.emit("onError",y,s)),this.callingUserIds=this.callingUserIds.filter((function(e){return!s.includes(e)})),this.log("signalGroupInvite success"),[2,Promise.resolve()]}}))}))},n.prototype.signalCancel=function(){return r(this,void 0,void 0,(function(){var e,t,n=this;return o(this,(function(s){switch(s.label){case 0:return[4,Promise.allSettled(this.callingUserIds.map((function(e){return n.signal.signalingCancel({channelId:n.channelInfo.channelId,account:e,requestId:n.requestId,offlineEnabled:!0})})))];case 1:return e=s.sent(),this.callStatus=l.idle,(t=this.callingUserIds.filter((function(t,n){return"rejected"===e[n].status}))).length&&(this.log("signalCancel part fail:",t),this.emit("onError",I,t)),this.callingUserIds=[],this.log("signalCancel success"),[2,Promise.resolve()]}}))}))},n.prototype.signalLeave=function(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,3,4]),[4,this.signal.signalingLeave({channelId:this.channelInfo.channelId,offlineEnabled:!0})];case 1:return t.sent(),this.log("signalLeave success"),[3,4];case 2:return e=t.sent(),this.log("signalLeave fail but resolve:",e),this.emit("onError",b),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},n.prototype.signalClose=function(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:if(t.trys.push([0,2,3,4]),!this.signal)throw d;if(!this.channelInfo)throw f;return[4,this.signal.signalingClose({channelId:this.channelInfo.channelId,offlineEnabled:!0})];case 1:return t.sent(),this.log("signalClose success"),[3,4];case 2:return e=t.sent(),this.log("signalClose fail but resolve:",this.channelInfo,e),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},n.prototype.joinSignalAndRTC=function(){return r(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:if(!this.channelInfo)return[2,Promise.reject(f)];if(!this.callType)return[2,Promise.reject(g)];n.label=1;case 1:return n.trys.push([1,4,,5]),[4,this.signal.signalingJoin({channelId:this.channelInfo.channelId,offlineEnabled:!0})];case 2:return e=n.sent(),this.setLocalUid(e.members[0].uid),[4,this.rtc.joinRTCChannel({channelName:this.channelInfo.channelId,type:this.callType,uid:this.uid})];case 3:return n.sent(),this.log("joinSignalAndRTC success",e),[3,5];case 4:return t=n.sent(),this.log("joinSignalAndRTC fail:",t),this.destroy(),[2,Promise.reject(t)];case 5:return[2]}}))}))},n.prototype.rtcLeave=function(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,3,4]),[4,this.rtc.rtcLeave()];case 1:return t.sent(),this.log("rtcLeave success"),[3,4];case 2:return e=t.sent(),this.log("rtcLeave fail but resolve:",e),this.emit("onError",w),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},n.prototype.acceptSignal=function(){return r(this,void 0,void 0,(function(){var e,t,n=this;return o(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),this.invitorChannelInfo?[4,this.signal.signalingAccept({channelId:this.invitorChannelInfo.channelId,account:this.invitorChannelInfo.from,requestId:this.invitorChannelInfo.requestId,offlineEnabled:!0,autoJoin:!0})]:[2,Promise.reject(T)];case 1:return e=s.sent(),this.log("signalingAccept success",e),this.uid=e.members.find((function(e){return e.accid===n.account})).uid,this.channelInfo=e,this.callType=this.invitorChannelInfo.type,e.members.forEach((function(e){n.userMap[e.uid]||(n.userMap[e.uid]=e.accid)})),this.invitorChannelInfo=null,this.log("acceptSignal success",e),this.isGroupCall?[4,this.rtc.joinRTCChannel({channelName:this.channelInfo.channelId,type:this.callType,uid:this.uid})]:[3,3];case 2:s.sent(),s.label=3;case 3:return[3,5];case 4:return t=s.sent(),this.log("acceptSignal fail:",t),this.destroy(),[2,Promise.reject(t)];case 5:return[2]}}))}))},n.prototype.rejectCall=function(e,t){return void 0===e&&(e=!1),r(this,void 0,void 0,(function(){var n,s;return o(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,3,4]),!this.signal)throw d;return n={channelId:t.channelId,account:t.account,requestId:t.requestId,offlineEnabled:!0},e&&(n.attachExt="601"),[4,this.signal.signalingReject(n)];case 1:return i.sent(),this.log("rejectCall success"),[3,4];case 2:return s=i.sent(),this.log("rejectCall fail:",t,s),[2,Promise.reject(s)];case 3:return e||(this.callStatus=l.idle),[7];case 4:return[2]}}))}))},n.prototype.setLocalUid=function(e){this.uid=e,this.userMap[e]=this.account},n.prototype.removeLocalUid=function(){delete this.userMap[this.uid],this.uid="",this.account=""},n.prototype.filterCallingUserByMembers=function(e){void 0===e&&(e=[]),this.log("filterCallingUserByMembers:",e),this.callingUserIds=this.callingUserIds.filter((function(t){return e.every((function(e){return e.account!==t}))}))},n.prototype.findUid=function(e){var t=this,n="";return Object.keys(this.userMap).forEach((function(s){t.userMap[s]===e&&(n=s)})),n},n.prototype.sendMessage=function(e,t){var n=this;return new Promise((function(s,r){if(!n.signal)return r(d);if(!n.callType)return r(g);if(!n.channelInfo)return r(f);if(!n.durations.length)return r(C);if(!e)return r("to is invalid");var o={type:n.callType,channelId:n.channelInfo.channelId,status:{complete:1,canceled:2,rejected:3,timeout:4,busy:5}[t],durations:n.durations.map((function(e){return i(i({},e),{duration:e.duration?(Date.now()-e.duration)/1e3:null})}))};n.signal.sendG2Msg({attach:o,scene:"p2p",to:e,done:function(t){if(t)return n.log("sendMessage fail:",o,t),r(t);n.log("sendMessage success",o,e),n.emit("onMessageSent",e),s()}})}))},n.prototype.batchMarkEvent=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,3,4]),t=e.map((function(e){return e.msgid+""})),[4,this.signal.signalingMarkMsgRead({msgid:t})];case 1:return s.sent(),this.log("在线 signalingMarkMsgRead success"),[3,4];case 2:return n=s.sent(),this.log("在线 signalingMarkMsgRead fail: ",n),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},n.prototype.resetChannel=function(){this.rtc.destroy(),this.channelInfo=null,this.callingUserIds=[],this.requestId="",this.callType=null,this.uid="",this.invitorChannelInfo=null,this.isGroupCall=!1,this.callStatus=l.idle,this.durations=[],this.userMap={},this.log("resetChannel success")},n.prototype.destroy=function(){return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,Promise.all([this.signalClose(),this.rtcLeave()])];case 1:return e.sent(),this.resetChannel(),this.log("destroy success"),[2]}}))}))},n.prototype.addEventListener=function(){var e=this;this.signal.on("signalingNotify",(function(t){return r(e,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.batchMarkEvent([t])];case 1:switch(e.sent(),t.eventType){case"ROOM_JOIN":this.signalRoomJoinHandler(t);break;case"ROOM_CLOSE":this.roomCloseHandler(t);break;case"INVITE":this.inviteHandler(t);break;case"CANCEL_INVITE":this.cancelInviteHandler(t);break;case"REJECT":this.rejectHandler(t);break;case"ACCEPT":this.acceptHandler(t);break;case"CONTROL":this.controlHandler(t)}return[2]}}))}))})),this.signal.on("signalingMutilClientSyncNotify",(function(t){return r(e,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return this.log("signalingMutilClientSyncNotify",t),[4,this.batchMarkEvent([t])];case 1:switch(e.sent(),t.eventType){case"REJECT":this.resetChannel(),this.emit("onOtherClientReject");break;case"ACCEPT":this.resetChannel(),this.emit("onOtherClientAccept")}return[2]}}))}))})),this.signal.on("signalingUnreadMessageSyncNotify",(function(t){return r(e,void 0,void 0,(function(){var e,n,s;return o(this,(function(i){switch(i.label){case 0:return this.log("signalingUnreadMessageSyncNotify",t),[4,this.batchMarkEvent(t)];case 1:return i.sent(),e=t.filter((function(e){return!e.channelInValid})),n=e.filter((function(e){return"REJECT"===e.eventType})),(s=e.filter((function(e){return"INVITE"===e.eventType})).sort((function(e,t){return t.channelCreateTime-e.channelCreateTime})))[0]&&n.every((function(e){return e.requestId!==s[0].requestId}))?[4,this.inviteHandler(s[0])]:[3,3];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))})),this.rtc.client.on("peer-online",(function(t){e.roomJoinHandler(t)})),this.rtc.client.on("peer-leave",(function(t){e.leaveHandler(t)})),this.rtc.client.on("stream-added",(function(t){return r(e,void 0,void 0,(function(){var e,n;return o(this,(function(s){switch(s.label){case 0:this.log("stream-added:",t),e=t.stream,this.rtc.addStream(e),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this.rtc.rtcSubscribe(e,{audio:!0,video:!0})];case 2:return s.sent(),[3,4];case 3:return n=s.sent(),this.log("stream-added fail: ",n),[3,4];case 4:return[2]}}))}))})),this.rtc.client.on("stream-removed",(function(t){e.log("stream-removed:","callType:",e.callType,t);var n=t.stream,s=n.getId();n.stop(),e.log("stream-removed：停止订阅流，更新流"),e.rtc.updateStream(n);var i=e.userMap[s];e.emit("onAudioAvailable",{userId:i,uid:s,available:n.audio}),2===e.callType&&e.emit("onCameraAvailable",{userId:i,uid:s,available:n.video})})),this.rtc.client.on("stream-subscribed",(function(t){return r(e,void 0,void 0,(function(){var e,n,s,i,r;return o(this,(function(o){switch(o.label){case 0:this.log("stream-subscribed:","callType:",this.callType,t),e=t.stream,n=e.getId(),s=this.userMap[n],this.emit("onAudioAvailable",{userId:s,uid:n,available:e.audio}),2===this.callType&&this.emit("onCameraAvailable",{userId:s,uid:n,available:e.video}),i=this.rtc.findRemoteView(n),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.rtc.startStreamPreview(e,"remote",i)];case 2:return o.sent(),this.log("startRemoteStreamPreview success",e,i),[3,4];case 3:return r=o.sent(),this.log("startRemoteStreamPreview fail: ",e,i,r),[3,4];case 4:return[2]}}))}))})),this.rtc.client.on("network-quality",(function(t){var n={};t.forEach((function(t){var s=e.userMap[t.uid];s&&(n[s]={uplinkNetworkQuality:t.uplinkNetworkQuality,downlinkNetworkQuality:t.downlinkNetworkQuality})})),e.emit("onUserNetworkQuality",n)})),this.rtc.client.on("connection-state-change",(function(t){"DISCONNECTED"===t&&e.emit("onDisconnect")}))},n.prototype.signalRoomJoinHandler=function(e){var t;this.log("signalRoomJoinHandler:",e);try{t=JSON.parse(e.attach)}catch(e){t={}}var n=(t.member||{})[2];this.filterCallingUserByMembers([{uid:n,account:e.from}]),this.userMap[n]=e.from},n.prototype.roomCloseHandler=function(e){return r(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return this.log("roomCloseHandler:",e),[4,this.destroy()];case 1:return t.sent(),this.emit("onCallEnd"),[2]}}))}))},n.prototype.roomJoinHandler=function(e){var t=this.userMap[e.uid];this.log("roomJoinHandler:",t,e),this.emit("onUserEnter",t)},n.prototype.acceptHandler=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:if(this.callStatus=l.inCall,this.emit("onUserAccept",e.from),this.isGroupCall)return this.log("acceptHandler from group:",e),[2,Promise.resolve()];n.label=1;case 1:if(n.trys.push([1,4,,5]),!this.channelInfo)throw f;if(!this.callType)throw g;if(!this.signal)throw d;return[4,this.rtc.joinRTCChannel({channelName:this.channelInfo.channelId,type:this.callType,uid:this.uid})];case 2:return n.sent(),this.durations.push({accid:e.from,duration:Date.now()}),[4,this.signal.signalingControl({channelId:this.channelInfo.channelId,account:e.from,attachExt:JSON.stringify({cid:1})})];case 3:return n.sent(),this.log("acceptHandler from signal success:",e),[3,5];case 4:return t=n.sent(),this.log("acceptHandler from signal fail:",e,t),this.emit("onError",t),[3,5];case 5:return[2]}}))}))},n.prototype.inviteHandler=function(e){return r(this,void 0,void 0,(function(){var t,n,s,i=this;return o(this,(function(a){switch(a.label){case 0:if(e.channelInValid)return[2];if(this.log("inviteHandler:","callStatus:",this.callStatus,e),this.callStatus===l.idle)return[3,5];a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.rejectCall(!0,{channelId:e.channelId,account:e.from,requestId:e.requestId})];case 2:return a.sent(),[3,4];case 3:return t=a.sent(),this.log("reject error in inviteHandler: ",t),[3,4];case 4:return[2];case 5:try{n=JSON.parse(e.attachExt)}catch(e){n={}}return s=Number(e.type),this.invitorChannelInfo={channelId:e.channelId,channelName:e.channelName,creatorId:e.creator,requestId:e.requestId,from:e.from,type:s},this.callStatus=l.called,this.isGroupCall=n.callType+""=="1",this.emit("onInvited",{invitor:e.from,userIds:n.callUserList,isFromGroup:this.isGroupCall,groupId:n.groupID,type:s}),void 0!==this.rejectTimeout&&setTimeout((function(){return r(i,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:if(this.callStatus!==l.called)return[3,5];t.label=1;case 1:return t.trys.push([1,3,4,5]),[4,this.rejectCall(!1,{channelId:this.invitorChannelInfo.channelId,account:this.invitorChannelInfo.from,requestId:this.invitorChannelInfo.requestId})];case 2:return t.sent(),this.log("reject timeout success",this.rejectTimeout),[3,5];case 3:return e=t.sent(),this.log("reject timeout fail: ",e,this.rejectTimeout),[3,5];case 4:return this.invitorChannelInfo=null,this.emit("onCallingTimeOut"),[7];case 5:return[2]}}))}))}),this.rejectTimeout),[2]}}))}))},n.prototype.cancelInviteHandler=function(e){this.log("cancelInviteHandler:",e),this.callStatus=l.idle,this.emit("onUserCancel",e.from)},n.prototype.rejectHandler=function(e){return r(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return Number(e.requestId)!==Number(this.requestId)||e.to!==this.account?(this.log("rejectHandler fail: invalid reject"),[2]):(this.log("rejectHandler:",e),this.filterCallingUserByMembers([{uid:"",account:e.from}]),"601"!==e.attachExt?[3,3]:(this.emit("onUserBusy",e.from),this.isGroupCall?[3,2]:[4,this.sendMessage(e.from,"busy")]));case 1:t.sent(),t.label=2;case 2:return[3,5];case 3:return this.emit("onUserReject",e.from),this.isGroupCall?[3,5]:[4,this.sendMessage(e.from,"rejected")];case 4:t.sent(),t.label=5;case 5:return this.isGroupCall?[3,7]:[4,this.destroy()];case 6:t.sent(),t.label=7;case 7:return[2]}}))}))},n.prototype.controlHandler=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(s){switch(s.label){case 0:this.log("controlHandler: ","channelInfo: ",this.channelInfo,"callType: ",this.callType,e),s.label=1;case 1:if(s.trys.push([1,6,,7]),!this.channelInfo)throw f;if(!this.callType)throw g;t=void 0;try{t=JSON.parse(e.attachExt)}catch(e){t={}}return 1!==t.cid?[3,3]:[4,this.rtc.joinRTCChannel({channelName:this.channelInfo.channelId,type:this.callType,uid:this.uid})];case 2:return s.sent(),this.isGroupCall||(this.durations=[{accid:this.userMap[this.uid],duration:Date.now()},{accid:e.from,duration:Date.now()}]),this.log("controlHandler joinRTCChannel success",this.durations),[3,5];case 3:return 2!==t.cid||1!==t.type?[3,5]:(this.emit("onCallTypeChange",1),[4,this.rtc.enableLocalVideo(!1)]);case 4:s.sent(),this.log("controlHandler switchCallType success"),s.label=5;case 5:return this.log("controlHandler success: "),[3,7];case 6:return n=s.sent(),this.log("controlHandler fail: ",n),[3,7];case 7:return[2]}}))}))},n.prototype.leaveHandler=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(s){return this.log("leaveHandler:",e),t=e.uid,this.rtc.removeStream(t),n=this.userMap[t],delete this.userMap[t],"0"===e.reason?this.emit("onUserLeave",n):this.emit("onUserDisconnect",n),[2]}))}))},n.getInstance=function(e){var t=(void 0===e?{debug:!0}:e).debug,s=void 0===t||t;return this.instance||(this.instance=new n({debug:s})),this.instance},n.version="1.0.1",n}(k);export{L as RTCCalling};
